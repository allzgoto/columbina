<script>
const entry = document.getElementById("entry");
const mainVideo = document.getElementById("mainVideo");
const bgAudio = document.getElementById("bgAudio");

/* ===== VOLUME PADRÃO 8% ===== */
let currentVol = 0.08;
bgAudio.volume = currentVol;

/* ===== CONTADORES (LOCAL) ===== */
const LS = {
  visits: "sf2_visits",
  enter: "sf2_enter",
  scroll: "sf2_scroll_open",
  admin: "sf2_admin_sessions",
};

function bump(key){
  const v = Number(localStorage.getItem(key) || "0") + 1;
  localStorage.setItem(key, String(v));
  return v;
}
function getCount(key){
  return Number(localStorage.getItem(key) || "0");
}
bump(LS.visits);

/* ===== CINZAS ===== */
const canvas = document.getElementById("ashCanvas");
const ctx = canvas.getContext("2d");
let W=0, H=0;

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  W = innerWidth; H = innerHeight;
}
resize();
addEventListener("resize", resize);

const ash=[];
const ASH_N = 190;
for(let i=0;i<ASH_N;i++){
  ash.push({
    x:Math.random()*W,
    y:Math.random()*H,
    r:Math.random()*2.2+0.5,
    v:Math.random()*0.62+0.18,
    drift:(Math.random()-0.5)*0.55,
    tw:Math.random()*0.9+0.1
  });
}
function drawAsh(){
  ctx.clearRect(0,0,W,H);
  for(const p of ash){
    p.y -= p.v;
    p.x += p.drift;
    if(p.y < -12){ p.y = H + 12; p.x = Math.random()*W; }
    if(p.x < -12) p.x = W + 12;
    if(p.x > W + 12) p.x = -12;
    const a = 0.08 + p.tw*0.16;
    ctx.beginPath();
    ctx.fillStyle = `rgba(210,210,210,${a})`;
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }
  requestAnimationFrame(drawAsh);
}
drawAsh();

/* ===== CLICK / ENTER ===== */
let started=false;
async function start(){
  if(started) return;
  started=true;

  bump(LS.enter);

  document.body.classList.add("strikeOn");

  try{
    bgAudio.currentTime = 0;
    bgAudio.volume = currentVol;
    await bgAudio.play();
  }catch(e){}

  setTimeout(async ()=>{
    try{
      mainVideo.muted = true; // vídeo sempre mudo (não atrapalha overlays)
      await mainVideo.play();
    }catch(e){}
    document.body.classList.add("entered");
  }, 1050);
}
entry.addEventListener("pointerdown", start);
entry.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" || e.key===" "){ e.preventDefault(); start(); }
});

/* ===== CONTROLE DE VOLUME ===== */
const grimoire = document.getElementById("grimoire");
const grimBtn = document.getElementById("grimBtn");
const vol = document.getElementById("vol");
const volValue = document.getElementById("volValue");

function setSliderVisual(v){
  vol.style.setProperty("--p", `${v}%`);
  volValue.textContent = `${v}%`;
}
setSliderVisual(8);

grimBtn.addEventListener("click",(e)=>{
  e.stopPropagation();
  grimoire.classList.toggle("open");
});
document.addEventListener("click",(e)=>{
  if(!grimoire.contains(e.target)) grimoire.classList.remove("open");
});
vol.addEventListener("input", ()=>{
  const v = Number(vol.value);
  setSliderVisual(v);
  currentVol = v/100;
  bgAudio.volume = currentVol;
});

/* ===== FULLSCREEN ===== */
const fsBtn = document.getElementById("fsBtn");
async function toggleFullscreen(){
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){}
}
fsBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  toggleFullscreen();
});

/* ===== PERGAMINHO ===== */
const scrollBtn = document.getElementById("scrollBtn");
const scrollOverlay = document.getElementById("scrollOverlay");
const scrollClose = document.getElementById("scrollClose");
const scrollLog = document.getElementById("scrollLog");
const typeLine = document.getElementById("typeLine");
const cursor = document.getElementById("cursor");
const out = document.getElementById("out");
const cmdInput = document.getElementById("cmdInput");

let typing = false;
let typedOnce = false;

const loreLines = [
  `<span class="who mestre">MESTRE:</span> A arena está silenciosa... mas as sombras nunca dormem.`,
  `<span class="who shadow">SHADOW:</span> Eu sinto o vazio se abrindo. Algo me chama do outro lado.`,
  `<span class="who titan">TITAN:</span> Você acha que pode escapar? Eu já marquei seu destino.`,
  `<span class="who mestre">MESTRE:</span> Não responda ao medo. Use-o. Transforme-o em lâmina.`,
  `<span class="who shadow">SHADOW:</span> Então... eu entro. E se eu cair, que as sombras me devorem.`,
  `<span class="who titan">TITAN:</span> Venha. Eu quero ouvir seu silêncio gritar.`
];

function openScroll(){
  if(!document.body.classList.contains("entered")) return;
  bump(LS.scroll);
  document.body.classList.add("scrollOpen");
  scrollOverlay.setAttribute("aria-hidden","false");
  setTimeout(()=>cmdInput.focus(), 80);

  if(!typedOnce){
    startTyping();
  }else{
    cursor.style.display = "none";
  }
}
function closeScroll(){
  document.body.classList.remove("scrollOpen");
  scrollOverlay.setAttribute("aria-hidden","true");
}

scrollBtn.addEventListener("click",(e)=>{
  e.stopPropagation();
  openScroll();
});
scrollClose.addEventListener("click", closeScroll);
scrollOverlay.addEventListener("click",(e)=>{
  if(e.target.classList.contains("dim")) closeScroll();
});

/* (SEM atalhos extras) — removi T / ESC */

/* Typing helpers */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function scrollToBottom(){ scrollLog.scrollTop = scrollLog.scrollHeight; }

function writeOut(html){
  const line = document.createElement("div");
  line.className = "outputLine";
  line.innerHTML = html;
  out.appendChild(line);
  scrollToBottom();
}

function finishTypingNow(){
  typing = false;
  cursor.style.display = "none";
  typeLine.innerHTML = loreLines.map(l => `<div class="typeLine">${l}</div>`).join("");
  const hasHint = out.textContent.includes("Digite ajuda");
  if(!hasHint){
    writeOut(`<span class="sys">SISTEMA:</span> Digite <b>ajuda</b> para ver comandos.`);
  }
}

async function startTyping(){
  if(typing) return;
  typing = true;
  typedOnce = true;

  typeLine.innerHTML = "";
  out.innerHTML = "";
  cursor.style.display = "inline-block";

  for(let i=0; i<loreLines.length; i++){
    if(!typing) break;

    const plain = loreLines[i].replace(/<[^>]*>/g, "");
    const holder = document.createElement("div");
    holder.className = "typeLine";
    typeLine.appendChild(holder);

    let acc = "";
    for(let c=0; c<plain.length; c++){
      if(!typing) break;
      acc += plain[c];
      holder.textContent = acc;
      scrollToBottom();
      await sleep(12 + Math.random()*18);
    }
    if(!typing) break;

    holder.innerHTML = loreLines[i];
    scrollToBottom();
    await sleep(220 + Math.random()*220);
  }

  if(typing){
    typing = false;
    cursor.style.display = "none";
    scrollToBottom();
    writeOut(`<span class="sys">SISTEMA:</span> Digite <b>ajuda</b> para ver comandos.`);
  }else{
    scrollToBottom();
  }
}

cmdInput.addEventListener("keydown", (e)=>{
  if(e.key !== "Enter") return;
  const raw = cmdInput.value.trim();
  if(!raw) return;
  cmdInput.value = "";

  if(typing) finishTypingNow();

  writeOut(`<span class="sys">VOCÊ:</span> ${escapeHtml(raw)}`);
  const cmd = raw.toLowerCase();

  if(cmd === "ajuda" || cmd === "help" || cmd === "?"){
    writeOut(`<span class="sys">COMANDOS:</span> <b>hub</b>, <b>arquivo</b>, <b>lore</b>, <b>fechar</b>`);
    return;
  }
  if(cmd === "fechar" || cmd === "close" || cmd === "exit"){
    writeOut(`<span class="sys">SISTEMA:</span> Pergaminho selado.`);
    setTimeout(closeScroll, 250);
    return;
  }
  if(cmd === "hub"){
    writeOut(`<span class="sys">SISTEMA:</span> (placeholder) Abrindo HUB...`);
    return;
  }
  if(cmd === "arquivo" || cmd === "archive"){
    writeOut(`<span class="sys">SISTEMA:</span> (placeholder) Abrindo ARQUIVO...`);
    return;
  }
  if(cmd === "lore"){
    writeOut(`<span class="sys">SISTEMA:</span> Você já ouviu as vozes... agora escolha um caminho.`);
    return;
  }

  writeOut(`<span class="sys">SISTEMA:</span> Comando desconhecido. Digite <b>ajuda</b>.`);
});

function escapeHtml(s){
  return s.replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
}

/* ===== ADMIN ===== */
const adminBtn = document.getElementById("adminBtn");
const adminOverlay = document.getElementById("adminOverlay");
const adminClose = document.getElementById("adminClose");
const adminUser = document.getElementById("adminUser");
const adminPass = document.getElementById("adminPass");
const adminEnter = document.getElementById("adminEnter");
const adminMsg = document.getElementById("adminMsg");
const adminPanel = document.getElementById("adminPanel");

const stVisits = document.getElementById("stVisits");
const stEnter = document.getElementById("stEnter");
const stScroll = document.getElementById("stScroll");
const stAdmin = document.getElementById("stAdmin");

const ADMIN_PASS = "Projeto26";

function openAdmin(){
  if(!document.body.classList.contains("entered")) return;
  document.body.classList.add("adminOpen");
  adminOverlay.setAttribute("aria-hidden","false");
  adminMsg.textContent = "";
  adminMsg.className = "adMsg";
  adminPass.value = "";
  adminPanel.style.display = "none";
  setTimeout(()=>adminPass.focus(), 80);
}
function closeAdmin(){
  document.body.classList.remove("adminOpen");
  adminOverlay.setAttribute("aria-hidden","true");
}

adminBtn.addEventListener("click",(e)=>{
  e.stopPropagation();
  openAdmin();
});
adminClose.addEventListener("click", closeAdmin);
adminOverlay.addEventListener("click",(e)=>{
  if(e.target.classList.contains("dim")) closeAdmin();
});

function fillStats(){
  stVisits.textContent = getCount(LS.visits);
  stEnter.textContent = getCount(LS.enter);
  stScroll.textContent = getCount(LS.scroll);
  stAdmin.textContent = getCount(LS.admin);
}

adminEnter.addEventListener("click", ()=>{
  const pass = adminPass.value.trim();
  if(pass !== ADMIN_PASS){
    adminMsg.textContent = "Acesso negado. As sombras não reconhecem você.";
    adminMsg.className = "adMsg bad";
    return;
  }
  bump(LS.admin);
  fillStats();
  adminPanel.style.display = "block";
  adminMsg.textContent = "Acesso concedido.";
  adminMsg.className = "adMsg good";
});

/* ===== MENU ===== */
const menu = document.getElementById("menu");
const menuBtn = document.getElementById("menuBtn");
const openSocial = document.getElementById("openSocial");
const openArchives = document.getElementById("openArchives");
const openPlaylists = document.getElementById("openPlaylists");

menuBtn.addEventListener("click",(e)=>{
  e.stopPropagation();
  menu.classList.toggle("open");
});
document.addEventListener("click",(e)=>{
  if(!menu.contains(e.target)) menu.classList.remove("open");
});

/* ===== SOCIAL MEDIA ===== */
const socialOverlay = document.getElementById("socialOverlay");
const socialClose = document.getElementById("socialClose");

function openSocialOverlay(){
  if(!document.body.classList.contains("entered")) return;
  document.body.classList.add("socialOpen");
  socialOverlay.setAttribute("aria-hidden","false");
  fetchLanyard();
}
function closeSocialOverlay(){
  document.body.classList.remove("socialOpen");
  socialOverlay.setAttribute("aria-hidden","true");
}

openSocial.addEventListener("click", ()=>{
  menu.classList.remove("open");
  openSocialOverlay();
});
openArchives.addEventListener("click", ()=>{
  menu.classList.remove("open");
  alert("(placeholder) Archives — entra na V2.1");
});
openPlaylists.addEventListener("click", ()=>{
  menu.classList.remove("open");
  alert("(placeholder) Playlists — entra na V2.1");
});
socialClose.addEventListener("click", closeSocialOverlay);
socialOverlay.addEventListener("click",(e)=>{
  if(e.target.classList.contains("dim")) closeSocialOverlay();
});

/* Discord status (Lanyard) */
const dPill = document.getElementById("dPill");
const dStatusTxt = document.getElementById("dStatusTxt");
const dUserLine = document.getElementById("dUserLine");
const dSubLine = document.getElementById("dSubLine");
const dTime = document.getElementById("dTime");

const dAvatar = document.getElementById("dAvatar");
const dAvatarFallback = document.getElementById("dAvatarFallback");

const LANYARD_ID = "513830615225860096";
const FORCED_USERNAME = "allzz.exe";

function niceStatus(s){
  if(s === "online") return "Online";
  if(s === "idle") return "Ausente";
  if(s === "dnd") return "Não perturbe";
  return "Offline";
}

function nowHHMM(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

async function fetchLanyard(){
  try{
    const r = await fetch(`https://api.lanyard.rest/v1/users/${LANYARD_ID}`, { cache: "no-store" });
    const j = await r.json();
    const data = j && j.data ? j.data : null;
    if(!data) return;

    const status = data.discord_status || "offline";
    const label = niceStatus(status);

    dPill.setAttribute("data-status", status);
    dStatusTxt.textContent = label;

    const du = data.discord_user || {};
    const display = du.global_name || du.display_name || du.username || "Allz";
    dUserLine.textContent = `${display} · ${FORCED_USERNAME}`;

    // subline (local / placeholders)
    // se o lanyard tiver activity, você pode mudar depois (V2.1)
    dSubLine.textContent = (status === "offline")
      ? "offline"
      : "ativo (Lanyard)";

    // Avatar real do Discord
    if(du.id){
      const fallbackIndex = (Number(du.discriminator || "0") % 5);
      const defaultAvatar = `https://cdn.discordapp.com/embed/avatars/${fallbackIndex}.png`;

      let avatarUrl = defaultAvatar;
      if(du.avatar){
        const isGif = String(du.avatar).startsWith("a_");
        avatarUrl = `https://cdn.discordapp.com/avatars/${du.id}/${du.avatar}.${isGif ? "gif" : "png"}?size=128`;
      }

      dAvatar.src = avatarUrl;
      dAvatar.style.display = "block";
      dAvatarFallback.style.display = "none";
    }else{
      dAvatar.style.display = "none";
      dAvatarFallback.style.display = "block";
    }

    dTime.textContent = `ATUALIZADO ÀS ${nowHHMM()}`;
  }catch(e){}
}

// loop leve (só pra social)
setInterval(()=>{
  if(document.body.classList.contains("socialOpen")) fetchLanyard();
}, 15000);
</script>
