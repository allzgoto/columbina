<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Panel ‚Äî Conversas</title>
  <style>
    :root{
      --bg:#0a0b0f;
      --stroke:rgba(255,255,255,.07);
      --text:#e9e9ee;
      --muted:#a2a2b3;
      --accent:#b300ff;
      --accent2:#ff00d4;
      --good:#33d17a;
      --warn:#f2b01e;
      --bad:#ff4d4d;
      --shadow:0 18px 60px rgba(0,0,0,.65);
      --radius:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 25% 10%, rgba(179,0,255,.12), transparent 60%),
        radial-gradient(900px 700px at 70% 0%, rgba(255,0,212,.08), transparent 55%),
        linear-gradient(180deg, var(--bg), #07080b);
      overflow:hidden;
    }
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 340px 1fr 360px;
      gap:14px;
      padding:14px;
    }

    /* LEFT */
    .left{
      background: linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .left__header{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--stroke);
      gap:10px;
      position:relative;
      z-index:5;
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:0}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--good);
      box-shadow:0 0 0 6px rgba(51,209,122,.12);
      flex:0 0 auto;
    }
    .brand__title{font-weight:900; letter-spacing:.2px}
    .brand__sub{font-size:12px;color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .left__actions{display:flex; gap:8px; flex:0 0 auto}

    /* Bigger, reliable hitbox */
    .iconbtn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition:transform .08s ease, background .15s ease;
      position:relative;
      z-index:6;
    }
    .iconbtn svg{pointer-events:none} /* <-- FIX: svg n√£o ‚Äúrouba‚Äù o clique */
    .iconbtn:hover{background:rgba(255,255,255,.06)}
    .iconbtn:active{transform:translateY(1px)}

    /* Queue tabs */
    .queues{
      padding:10px 12px 0;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .qtab{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .qtab.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
      box-shadow:0 0 0 6px rgba(179,0,255,.08);
    }
    .qbadge{
      font-size:11px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(179,0,255,.22);
      background:rgba(179,0,255,.10);
      color:rgba(255,255,255,.92);
    }

    .search{padding:10px 14px}
    .search input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .search input::placeholder{color:rgba(255,255,255,.35)}

    .list{
      padding:6px;
      overflow:auto;
      flex:1;
    }
    .ticket{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid transparent;
      background:rgba(255,255,255,.02);
      margin:6px;
      cursor:pointer;
      display:grid;
      gap:6px;
      transition:background .12s ease, border-color .12s ease;
    }
    .ticket:hover{background:rgba(255,255,255,.045)}
    .ticket.active{
      border-color:rgba(179,0,255,.35);
      background: linear-gradient(180deg, rgba(179,0,255,.12), rgba(255,0,212,.06));
    }
    .ticket__top{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .ticket__name{font-weight:900}
    .ticket__meta{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.09);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{color:var(--good); border-color:rgba(51,209,122,.25); background:rgba(51,209,122,.08)}
    .badge.warn{color:var(--warn); border-color:rgba(242,176,30,.25); background:rgba(242,176,30,.08)}
    .badge.bad{color:var(--bad); border-color:rgba(255,77,77,.25); background:rgba(255,77,77,.08)}
    .ticket__snippet{font-size:13px; color:rgba(255,255,255,.78); line-height:1.25}
    .ticket__tags{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(179,0,255,.22);
      background:rgba(179,0,255,.08);
      color:rgba(255,255,255,.9);
      cursor:pointer;
      user-select:none;
    }
    .unreadDot{
      width:8px;height:8px;border-radius:50%;
      background:rgba(255,0,212,.9);
      box-shadow:0 0 0 6px rgba(255,0,212,.10);
      display:inline-block;
    }

    /* Filters drawer */
    .filters{
      position:absolute;
      top:0; right:-320px;
      width:300px;
      height:100%;
      max-height:100%;
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(8,9,12,.98));
      border-left:1px solid var(--stroke);
      transition:right .22s ease;
      box-shadow:-18px 0 60px rgba(0,0,0,.55);
      padding:14px 12px;
      overflow:auto;
      z-index:10;
    }
    .filters.open{right:0}
    .filters__header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid var(--stroke);
      position:sticky;
      top:0;
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(12,14,20,.92));
      z-index:2;
      margin:-14px -12px 10px;
      padding:14px 12px 10px;
    }
    .filters__title{font-weight:900}
    .filters__section{padding:12px 0; border-bottom:1px solid rgba(255,255,255,.05)}
    .filters__label{font-size:12px; color:var(--muted); margin-bottom:10px; text-transform:uppercase; letter-spacing:.8px}
    .pillRow{display:flex; flex-wrap:wrap; gap:8px}
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
      box-shadow:0 0 0 6px rgba(179,0,255,.08);
    }
    .check{display:flex; align-items:center; gap:10px; color:rgba(255,255,255,.85); font-size:13px; margin:8px 0}
    .check input{accent-color: var(--accent)}
    .select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .tagCloud{display:flex; flex-wrap:wrap; gap:8px}
    .tagCloud .tag{
      border-color:rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.85);
    }
    .tagCloud .tag.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
    }

    /* CENTER */
    .center{
      background: linear-gradient(180deg, rgba(15,17,24,.78), rgba(8,9,12,.78));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
      position:relative;
    }
    .center__top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      position:relative;
      z-index:6;
    }
    .banner{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
      min-width:0;
    }
    .banner span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .center__topRight{display:flex; gap:10px; align-items:center}
    .btn{
      height:38px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      letter-spacing:.4px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      gap:8px;
      position:relative;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:active{transform:translateY(1px)}
    .btn.warn{
      border-color:rgba(242,176,30,.25);
      background:rgba(242,176,30,.08);
    }
    .btn.ghost{
      border-color:rgba(179,0,255,.25);
      background:rgba(179,0,255,.10);
    }
    .btn.small{height:34px; border-radius:12px; padding:0 12px; font-weight:900}
    .dotSmall{
      width:7px;height:7px;border-radius:50%;
      background:rgba(179,0,255,.95);
      box-shadow:0 0 0 6px rgba(179,0,255,.12);
    }

    /* Notification bell + panel */
    .bell{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      cursor:pointer;
      position:relative;
    }
    .bell svg{pointer-events:none}
    .bell:hover{background:rgba(255,255,255,.06)}
    .bellBadge{
      position:absolute;
      top:6px; right:6px;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
      font-weight:900;
      color:#fff;
      background:rgba(255,0,212,.95);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }

    .notiPanel{
      position:absolute;
      right:14px;
      top:60px;
      width:min(420px, calc(100vw - 28px));
      max-height:70vh;
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(179,0,255,.25);
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(8,9,12,.98));
      box-shadow:0 18px 70px rgba(0,0,0,.72);
      display:none;
      z-index:50;
    }
    .notiPanel.open{display:block}
    .notiHead{
      position:sticky; top:0;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(12,14,20,.92));
    }
    .notiTitle{font-weight:900}
    .notiActions{display:flex; gap:8px}
    .miniBtn{
      height:34px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.9);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .miniBtn:hover{background:rgba(255,255,255,.06)}
    .notiItem{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      cursor:pointer;
    }
    .notiItem:hover{background:rgba(255,255,255,.03)}
    .notiDot{
      width:10px;height:10px;border-radius:50%;
      background:rgba(255,0,212,.95);
      box-shadow:0 0 0 6px rgba(255,0,212,.10);
      flex:0 0 auto;
      margin-top:4px;
    }
    .notiText b{font-weight:900}
    .notiMeta{margin-top:3px; font-size:12px; color:rgba(255,255,255,.65)}
    .notiEmpty{padding:14px; color:rgba(255,255,255,.55); font-size:13px}

    .chatWrap{flex:1; display:flex; flex-direction:column; min-height:0}
    .chat{
      padding:18px 18px 10px;
      overflow:auto;
      flex:1;
    }
    .sys{
      width:100%;
      display:flex;
      justify-content:center;
      margin:10px 0;
    }
    .sys .sys__bubble{
      padding:10px 12px;
      max-width:900px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      color:rgba(255,255,255,.7);
      font-size:13px;
    }
    .msgRow{display:flex; margin:10px 0}
    .msgRow.me{justify-content:flex-end}
    .bubble{
      max-width:min(900px, 80%);
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.88);
      line-height:1.25;
      box-shadow:0 10px 35px rgba(0,0,0,.35);
      position:relative;
      font-size:14px;
      white-space:pre-wrap;
    }
    .bubble.me{
      background:linear-gradient(180deg, rgba(179,0,255,.92), rgba(179,0,255,.70));
      border-color:rgba(255,255,255,.12);
      color:#fff;
    }
    .bubble .meta{
      margin-top:8px;
      font-size:11px;
      color:rgba(255,255,255,.75);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }
    .delBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.15);
      color:rgba(255,255,255,.9);
      border-radius:10px;
      padding:3px 8px;
      cursor:pointer;
      font-weight:900;
      font-size:11px;
      display:none;
    }
    .msgRow.me .bubble:hover .delBtn{display:inline-flex}
    .composer{
      padding:12px;
      border-top:1px solid var(--stroke);
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(0,0,0,.12);
    }
    .composer input{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .send{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(179,0,255,.35);
      background:rgba(179,0,255,.18);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition:transform .08s ease, background .15s ease;
    }
    .send:hover{background:rgba(179,0,255,.25)}
    .send:active{transform:translateY(1px)}

    /* RIGHT */
    .right{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .stat{
      background:linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow:var(--shadow);
    }
    .stat__label{
      font-size:11px;
      letter-spacing:1px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .stat__value{
      margin-top:8px;
      font-size:18px;
      font-weight:900;
    }

    .panel{
      background:linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel__tabs{
      display:flex;
      border-bottom:1px solid var(--stroke);
      gap:8px;
      padding:10px;
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:900;
    }
    .tab.active{
      border-color:rgba(179,0,255,.35);
      background:rgba(179,0,255,.12);
    }
    .panel__header{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
    }
    .panel__title{font-weight:900}
    .panel__body{padding:14px}
    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .row:last-child{border-bottom:none}
    .k{color:var(--muted); font-size:12px}
    .v{font-weight:900}
    .v.link{
      color:rgba(179,0,255,.95);
      text-decoration:none;
      font-weight:900;
      word-break:break-all;
    }
    .v.link:hover{text-decoration:underline}
    .muted{color:rgba(255,255,255,.45); font-size:12px}

    .tagRow{display:flex; flex-wrap:wrap; gap:8px}
    .tagRow .tag{border-color:rgba(179,0,255,.25); background:rgba(179,0,255,.10)}
    .tagRow .tag.removable{position:relative; padding-right:26px}
    .tagRow .tag.removable::after{
      content:"√ó";
      position:absolute;
      right:9px; top:3px;
      opacity:.85;
      font-weight:900;
    }
    .tagAdd{display:flex; gap:8px; margin-top:12px}
    .tagAdd input{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }

    /* Toast notifications */
    .toasts{
      position:fixed;
      right:14px;
      top:14px;
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      width:min(420px, calc(100vw - 28px));
      border-radius:16px;
      border:1px solid rgba(179,0,255,.25);
      background:linear-gradient(180deg, rgba(179,0,255,.20), rgba(15,17,24,.92));
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: toastIn .18s ease-out;
    }
    @keyframes toastIn{
      from{transform:translateY(-8px); opacity:.0}
      to{transform:translateY(0); opacity:1}
    }
    .toast b{font-weight:900}
    .toast .tmeta{font-size:12px; color:rgba(255,255,255,.7); margin-top:4px}
    .toast .ticon{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      flex:0 0 auto;
    }

    /* Scrollbars */
    .list::-webkit-scrollbar, .chat::-webkit-scrollbar, .filters::-webkit-scrollbar, .notiPanel::-webkit-scrollbar{width:10px}
    .list::-webkit-scrollbar-thumb, .chat::-webkit-scrollbar-thumb, .filters::-webkit-scrollbar-thumb, .notiPanel::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.08);
      border:2px solid rgba(0,0,0,0);
      background-clip:padding-box;
      border-radius:999px;
    }
    .list::-webkit-scrollbar-track, .chat::-webkit-scrollbar-track, .filters::-webkit-scrollbar-track, .notiPanel::-webkit-scrollbar-track{
      background:transparent;
    }

    /* Responsive */
    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns: 340px 1fr; grid-template-rows:auto auto; height:auto}
      .right{grid-column: 1 / -1}
    }
    @media (max-width: 820px){
      body{overflow:auto}
      .app{grid-template-columns: 1fr; padding:10px}
      .left,.center,.right{border-radius:16px}
      .filters{
        position:fixed;
        top:10px;
        bottom:10px;
        height:auto;
        right:-100vw;
        width:min(92vw, 360px);
        border-radius:16px;
        border:1px solid var(--stroke);
      }
      .filters.open{right:10px}
      .filters__header{
        border-top-left-radius:16px;
        border-top-right-radius:16px;
      }
      .notiPanel{
        right:10px;
        top:76px;
        width:min(92vw, 420px);
      }
    }
  </style>
</head>
<body>
  <div class="toasts" id="toasts"></div>

  <div class="app">
    <!-- LEFT -->
    <aside class="left">
      <div class="left__header">
        <div class="brand">
          <div class="dot"></div>
          <div style="min-width:0">
            <div class="brand__title">Conversas</div>
            <div class="brand__sub">Bem-vindo(a), <b id="agentName">Allz</b> ‚Ä¢ <span id="liveLabel">ao vivo</span></div>
          </div>
        </div>
        <div class="left__actions">
          <button class="iconbtn" id="btnFilters" title="Filtros">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- QUEUE TABS -->
      <div class="queues" id="queueTabs"></div>

      <div class="search">
        <input id="searchInput" type="text" placeholder="Pesquisar..." />
      </div>

      <div class="list" id="ticketList"></div>

      <!-- FILTERS DRAWER -->
      <div class="filters" id="filters">
        <div class="filters__header">
          <div class="filters__title">Filtros</div>
          <button class="iconbtn" id="btnCloseFilters" title="Fechar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <div class="filters__section">
          <div class="filters__label">Status pagamento</div>
          <div class="pillRow" id="statusPills"></div>
        </div>

        <div class="filters__section">
          <label class="check">
            <input type="checkbox" id="onlyUnread" />
            <span>Apenas n√£o lidos</span>
          </label>
          <label class="check">
            <input type="checkbox" id="onlyMine" />
            <span>Meus tickets</span>
          </label>
          <label class="check">
            <input type="checkbox" id="soundOn" />
            <span>Som de notifica√ß√£o</span>
          </label>
          <label class="check">
            <input type="checkbox" id="demoSim" />
            <span>Simular mensagens (DEMO)</span>
          </label>
        </div>

        <div class="filters__section">
          <div class="filters__label">Ordenar por</div>
          <select id="sortBy" class="select">
            <option value="recent">Mais recentes</option>
            <option value="old">Mais antigos</option>
          </select>
        </div>

        <div class="filters__section">
          <div class="filters__label">Filtrar por Tag</div>
          <div class="tagCloud" id="tagCloud"></div>
          <div class="muted" style="margin-top:8px">
            *Tags aparecem conforme voc√™ adiciona nos tickets.
          </div>
        </div>

        <div class="filters__section" style="border-bottom:none">
          <div class="filters__label">Atualiza√ß√£o</div>
          <div class="muted">Agora a notifica√ß√£o tem central (sininho) e anti-spam.</div>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div class="center__top">
        <div class="banner">
          <span>üéâ</span>
          <span id="bannerText">Pagamento confirmado! Seu pedido est√° sendo processado...</span>
        </div>

        <div class="center__topRight">
          <!-- Notification Bell -->
          <button class="bell" id="btnBell" title="Notifica√ß√µes">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              <path d="M13.73 21a2 2 0 01-3.46 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
            <span class="bellBadge" id="bellBadge" style="display:none">0</span>
          </button>

          <button class="btn ghost" id="btnLiberar"><span class="dotSmall"></span>LIBERAR</button>
          <button class="btn warn" id="btnResolver">RESOLVER</button>
        </div>
      </div>

      <!-- Notification Panel -->
      <div class="notiPanel" id="notiPanel" aria-hidden="true">
        <div class="notiHead">
          <div class="notiTitle">Notifica√ß√µes</div>
          <div class="notiActions">
            <button class="miniBtn" id="btnMarkAllRead">Ler tudo</button>
            <button class="miniBtn" id="btnClearNoti">Limpar</button>
          </div>
        </div>
        <div id="notiList"></div>
      </div>

      <div class="chatWrap">
        <div class="chat" id="chat"></div>

        <div class="composer">
          <input id="msgInput" type="text" placeholder="Digite sua mensagem..." />
          <button class="send" id="btnSend" title="Enviar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M22 2L15 22l-4-9-9-4L22 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="right">
      <div class="stats">
        <div class="stat">
          <div class="stat__label">GASTOS</div>
          <div class="stat__value">R$ <span id="statSpent">13</span></div>
        </div>
        <div class="stat">
          <div class="stat__label">PEDIDOS</div>
          <div class="stat__value" id="statOrders">1</div>
        </div>
        <div class="stat">
          <div class="stat__label">ITENS</div>
          <div class="stat__value" id="statItems">1</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel__tabs">
          <button class="tab active" data-tab="info">Info</button>
          <button class="tab" data-tab="items">Items</button>
          <button class="tab" data-tab="actions">A√ß√µes</button>
        </div>
        <div class="panel__body" id="panelBody"></div>
      </div>

      <div class="panel">
        <div class="panel__header"><div class="panel__title">Tags do Ticket</div></div>
        <div class="panel__body">
          <div class="tagRow" id="ticketTags"></div>

          <div class="tagAdd">
            <input id="tagInput" type="text" placeholder="Adicionar tag (ex: MM2, ENTREGUE, BUG...)" />
            <button class="btn small" id="btnAddTag">Adicionar</button>
          </div>

          <div class="muted" style="margin-top:10px">
            Dica: clique numa tag acima para remover.
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    /***********************
     * STAFF PANEL v3.1
     * FIXES:
     * - Notification anti-spam
     * - Notification center (bell + panel)
     * - Filter icon hitbox reliably clickable
     ***********************/
    const LS_KEY = "staff_panel_v3_1";
    const AGENT = "Allz";

    const AUTO_REMOVE_DELIVERED_MS = 60 * 60 * 1000; // 1 hour
    const POLL_MS = 2500; // refresh interval
    const SIMULATE_REPLY_PROB = 0.22;

    const QUEUES = [
      { id:"all", label:"TODAS" },
      { id:"DTI", label:"DTI" },
      { id:"PEDIDOS_NOVOS", label:"PEDIDOS NOVOS" },
      { id:"SEM_GAMEPASS", label:"SEM GAMEPASS" },
      { id:"BLOXFRUITS", label:"BLOXFRUITS" },
      { id:"MM2", label:"MM2" },
      { id:"FILA_DE_ENTREGA", label:"FILA DE ENTREGA" },
    ];

    const STATUS = [
      { id:"all", label:"Todos" },
      { id:"paid", label:"Pagos" },
      { id:"pending", label:"Pendentes" },
      { id:"refunded", label:"Reembolsados" },
      { id:"canceled", label:"Cancelados" },
    ];

    function nowMinusMinutes(m){ return Date.now() - (m*60*1000); }
    function rid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

    function normalizeTag(tag){
      return String(tag).trim().toUpperCase().replace(/\s+/g,"_");
    }
    function uniqueTags(arr){
      const set = new Set(arr.map(normalizeTag));
      return Array.from(set);
    }

    function seedTicketsBase(){
      return [
        {
          id:"t1",
          queue:"PEDIDOS_NOVOS",
          name:"Kamila",
          user:"Wzkamila",
          createdAt: nowMinusMinutes(35),
          unread:true,
          mine:true,
          status:"pending",
          category:"ROBUX_GAMEPASS",
          total:"R$ 12,60",
          nick:"revoltadinha13",
          gamepass:"https://www.roblox.com/game-pass/1573179189",
          item:"300 Robux (via Gamepass)",
          client:"Esmeralda",
          clientEmail:"cm5592521@gmail.com",
          spent:13, orders:1, items:1,
          tags:["GAMEPASS","SEM_GAMEPASS"],
          deliveredAt:null,
          messages: [
            { id: rid(), type:"sys", text:"üéâ Pagamento confirmado! Seu pedido est√° sendo processado. Nossa equipe entrar√° em contato em breve para realizar a entrega." },
            { id: rid(), type:"sys", text:"Allz assumiu este atendimento." },
            { id: rid(), type:"me", text:"Ol√°! Muito obrigado pela sua compra, caso tenha alguma d√∫vida, pode me informar aqui ou l√° no discord, abrindo suporte. Entregaremos o mais r√°pido poss√≠vel, ainda hoje! üíú", at: nowMinusMinutes(30)},
            { id: rid(), type:"me", text:"Verifiquei que ainda n√£o enviou sua gamepass, precisa de ajuda com isso? Caso ela apenas n√£o tenha sido encontrada, v√° em \"minhas compras\" e selecione a compra que est√° tendo problemas, ap√≥s isso √© s√≥ clicar em \"inserir link manualmente\" e colocar o link de sua gamepass! Lembre-se de desativar os pre√ßos regionais.", at: nowMinusMinutes(28)},
          ],
          lastSeenMsgCount: 0,
          lastNotifiedCount: 0
        },
        {
          id:"t2",
          queue:"MM2",
          name:"Lipe nuts",
          user:"lipezzk077",
          createdAt: nowMinusMinutes(55),
          unread:false,
          mine:false,
          status:"paid",
          category:"MM2",
          total:"R$ 49,90",
          nick:"lipezzk077",
          gamepass:"-",
          item:"MM2 ‚Äî Pacote",
          client:"Lipe",
          clientEmail:"-",
          spent:49.9, orders:1, items:1,
          tags:["ENTREGUE","MM2"],
          deliveredAt: Date.now() - (25 * 60 * 1000),
          messages: [
            { id: rid(), type:"sys", text:"Pagamento confirmado! Pedido liberado para entrega." },
            { id: rid(), type:"me", text:"Pedido recebido! J√° estou separando seu item. ‚úÖ", at: nowMinusMinutes(52)},
            { id: rid(), type:"them", text:"Opa, beleza! Valeu", at: nowMinusMinutes(51)},
            { id: rid(), type:"me", text:"Entregue! Se precisar de algo, chama. üíú", at: nowMinusMinutes(50)},
          ],
          lastSeenMsgCount: 0,
          lastNotifiedCount: 0
        },
        {
          id:"t3",
          queue:"SEM_GAMEPASS",
          name:"DUDAXLSANTOS",
          user:"DUDAXLSANTOS",
          createdAt: nowMinusMinutes(80),
          unread:true,
          mine:true,
          status:"pending",
          category:"ROBUX_GAMEPASS",
          total:"R$ 25,00",
          nick:"dudaxl",
          gamepass:"https://www.roblox.com/game-pass/123456789",
          item:"500 Robux (via Gamepass)",
          client:"Duda",
          clientEmail:"-",
          spent:25, orders:1, items:1,
          tags:["GAMEPASS","SEM_GAMEPASS"],
          deliveredAt:null,
          messages: [
            { id: rid(), type:"sys", text:"Pagamento confirmado! Seu pedido est√° sendo processado." },
            { id: rid(), type:"sys", text:"Allz assumiu este atendimento." },
            { id: rid(), type:"them", text:"Oi, eu n√£o achei onde manda o link", at: nowMinusMinutes(78)},
          ],
          lastSeenMsgCount: 0,
          lastNotifiedCount: 0
        },
        {
          id:"t4",
          queue:"DTI",
          name:"w1s.",
          user:"southnak",
          createdAt: nowMinusMinutes(110),
          unread:true,
          mine:false,
          status:"pending",
          category:"MM2",
          total:"R$ 19,90",
          nick:"southnak",
          gamepass:"-",
          item:"MM2 ‚Äî Item avulso",
          client:"w1s",
          clientEmail:"-",
          spent:19.9, orders:1, items:1,
          tags:["MM2","MUDAR_TAG"],
          deliveredAt:null,
          messages: [
            { id: rid(), type:"sys", text:"Pedido em an√°lise." },
            { id: rid(), type:"them", text:"Posso esperar, s√≥ me avisa aqui", at: nowMinusMinutes(108)},
          ],
          lastSeenMsgCount: 0,
          lastNotifiedCount: 0
        },
        {
          id:"t5",
          queue:"FILA_DE_ENTREGA",
          name:"b.ferrazxl",
          user:"brunoteixeiraferrazferraz@gmail.com",
          createdAt: nowMinusMinutes(140),
          unread:false,
          mine:false,
          status:"refunded",
          category:"MM2",
          total:"R$ 12,00",
          nick:"brunoteixeira",
          gamepass:"-",
          item:"MM2 ‚Äî Item",
          client:"Bruno",
          clientEmail:"brunoteixeiraferrazferraz@gmail.com",
          spent:12, orders:1, items:1,
          tags:["REEMBOLSO","MM2"],
          deliveredAt:null,
          messages: [
            { id: rid(), type:"sys", text:"Reembolso processado." },
            { id: rid(), type:"me", text:"Reembolso conclu√≠do. üíú", at: nowMinusMinutes(138)},
          ],
          lastSeenMsgCount: 0,
          lastNotifiedCount: 0
        },
      ];
    }

    function generateExtraTickets(count){
      const names = ["ThayS","Nina","Renan","Bryan","Laura","Let√≠cia","Paulo","Yasmim","Brenda","Miguel","Gabi","Rafa","Davi","Malu","Caio","Luan","Iza","Noah","Bia","Hugo","Ana","Vini","Lara","Gui","Theo"];
      const users = ["thaysw0","ninaz","renan_77","bryanbr","laura_s","leticia_m","paulo00","yas_kk","brendaX","migrez","gabi_13","rafaelo","davi_x","maluzita","caio_rbx","luanbr","iza_rob","noahdev","bianca2","hugoz","ana_mod","vini33","lara_f","gui_k","theo_01"];
      const categories = ["MM2","ROBUX_GAMEPASS","BLOXFRUITS","MM2","ROBUX_GAMEPASS"];
      const items = ["MM2 ‚Äî Godly","MM2 ‚Äî Pacote","BloxFruits ‚Äî Fruta","500 Robux (via Gamepass)","BloxFruits ‚Äî Pass"];
      const tagsPool = ["MM2","GAMEPASS","ENTREGUE","REEMBOLSO","MUDAR_TAG","URGENTE","BUG","FALTA_LINK","PAGAMENTO","D√öVIDA","SEM_GAMEPASS","DTI"];
      const statuses = ["pending","paid","refunded","canceled"];
      const queuePool = ["DTI","PEDIDOS_NOVOS","SEM_GAMEPASS","BLOXFRUITS","MM2","FILA_DE_ENTREGA"];

      const out = [];
      for(let i=0;i<count;i++){
        const idx = i % names.length;
        const status = statuses[i % statuses.length];
        const cat = categories[i % categories.length];
        const queue = queuePool[i % queuePool.length];
        const tagA = tagsPool[(i*3) % tagsPool.length];
        const tagB = tagsPool[(i*3 + 2) % tagsPool.length];

        const id = "tx" + (i+1);
        const createdAt = nowMinusMinutes(170 + i*9);
        const unread = (i % 3) !== 0;
        const mine = (i % 4) === 0;

        const item = items[i % items.length];
        const nick = users[idx];

        const deliveredAt = (status==="paid" ? (Date.now() - ((10 + (i%70)) * 60 * 1000)) : null);

        out.push({
          id,
          queue,
          name: names[idx],
          user: users[idx],
          createdAt,
          unread,
          mine,
          status,
          category: cat,
          total: "R$ " + (10 + (i%7)*3) + ",90",
          nick,
          gamepass: cat === "ROBUX_GAMEPASS" ? "https://www.roblox.com/game-pass/123456" + (100+i) : "-",
          item,
          client: names[idx],
          clientEmail: "-",
          spent: 10 + (i%7)*3,
          orders: 1,
          items: 1,
          tags: uniqueTags([tagA, tagB, cat, queue]),
          deliveredAt,
          messages: [
            { id: rid(), type:"sys", text: "Ticket criado no sistema." },
            ...(mine ? [{ id: rid(), type:"sys", text: AGENT + " assumiu este atendimento." }] : []),
            { id: rid(), type:"them", text: cat==="ROBUX_GAMEPASS" ? "Opa, onde envio o link da gamepass?" : "Oi, quando entrega meu item?", at: createdAt + 2*60*1000 },
            ...(status==="paid" ? [{ id: rid(), type:"me", text:"Entregue ‚úÖ qualquer coisa chama!", at: createdAt + 6*60*1000 }] : []),
            ...(status==="refunded" ? [{ id: rid(), type:"me", text:"Reembolso processado. üíú", at: createdAt + 6*60*1000 }] : []),
            ...(status==="canceled" ? [{ id: rid(), type:"me", text:"Pedido cancelado conforme solicitado.", at: createdAt + 6*60*1000 }] : []),
          ],
          lastSeenMsgCount: 0,
          lastNotifiedCount: 0
        });
      }
      return out;
    }

    const seedData = () => {
      const base = seedTicketsBase();
      const extra = generateExtraTickets(15);
      return {
        me: AGENT,
        selectedId: base[0]?.id || null,
        filters: {
          queue: "all",
          status: "all",
          tag: "all",
          onlyUnread: false,
          onlyMine: false,
          sortBy: "recent",
          search: "",
          soundOn: false,
          demoSim: true
        },
        tickets: base.concat(extra),
        notifications: [] // {id, ticketId, name, text, at, read}
      };
    };

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return seedData();
        const parsed = JSON.parse(raw);
        if(!parsed.tickets || !Array.isArray(parsed.tickets)) return seedData();

        parsed.filters = parsed.filters || {};
        parsed.filters.queue = parsed.filters.queue || "all";
        parsed.filters.soundOn = !!parsed.filters.soundOn;
        parsed.filters.demoSim = parsed.filters.demoSim !== false;

        parsed.notifications = Array.isArray(parsed.notifications) ? parsed.notifications : [];

        parsed.tickets.forEach(t=>{
          t.queue = t.queue || "PEDIDOS_NOVOS";
          t.tags = (t.tags || []).map(normalizeTag);
          t.deliveredAt = t.deliveredAt ?? null;
          t.messages = (t.messages || []).map(m => ({ id: m.id || rid(), ...m }));
          t.lastSeenMsgCount = t.lastSeenMsgCount || 0;
          t.lastNotifiedCount = t.lastNotifiedCount || 0; // <- anti spam
        });
        return parsed;
      }catch{
        return seedData();
      }
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    let state = load();

    // Elements
    const elTicketList = document.getElementById("ticketList");
    const elChat = document.getElementById("chat");
    const elPanelBody = document.getElementById("panelBody");
    const elTicketTags = document.getElementById("ticketTags");
    const elTagInput = document.getElementById("tagInput");
    const elBtnAddTag = document.getElementById("btnAddTag");
    const elSearch = document.getElementById("searchInput");
    const elOnlyUnread = document.getElementById("onlyUnread");
    const elOnlyMine = document.getElementById("onlyMine");
    const elSortBy = document.getElementById("sortBy");
    const elStatusPills = document.getElementById("statusPills");
    const elTagCloud = document.getElementById("tagCloud");
    const elBanner = document.getElementById("bannerText");
    const elQueueTabs = document.getElementById("queueTabs");
    const elSoundOn = document.getElementById("soundOn");
    const elDemoSim = document.getElementById("demoSim");
    const elToasts = document.getElementById("toasts");

    // Notifications
    const elBell = document.getElementById("btnBell");
    const elBellBadge = document.getElementById("bellBadge");
    const elNotiPanel = document.getElementById("notiPanel");
    const elNotiList = document.getElementById("notiList");
    const elBtnMarkAllRead = document.getElementById("btnMarkAllRead");
    const elBtnClearNoti = document.getElementById("btnClearNoti");

    // Filters drawer
    const elFilters = document.getElementById("filters");
    document.getElementById("btnFilters").addEventListener("click", () => elFilters.classList.add("open"));
    document.getElementById("btnCloseFilters").addEventListener("click", () => elFilters.classList.remove("open"));
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        elFilters.classList.remove("open");
        elNotiPanel.classList.remove("open");
      }
    });

    // Tabs
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        renderRightPanel();
      });
    });

    // Persist inputs
    elSearch.value = state.filters.search || "";
    elOnlyUnread.checked = !!state.filters.onlyUnread;
    elOnlyMine.checked = !!state.filters.onlyMine;
    elSortBy.value = state.filters.sortBy || "recent";
    elSoundOn.checked = !!state.filters.soundOn;
    elDemoSim.checked = !!state.filters.demoSim;

    elSearch.addEventListener("input", (e)=>{
      state.filters.search = e.target.value;
      save();
      renderTicketsPreserveScroll();
      renderQueueTabs();
    });
    elOnlyUnread.addEventListener("change", ()=>{
      state.filters.onlyUnread = elOnlyUnread.checked;
      save();
      renderTicketsPreserveScroll();
      renderQueueTabs();
    });
    elOnlyMine.addEventListener("change", ()=>{
      state.filters.onlyMine = elOnlyMine.checked;
      save();
      renderTicketsPreserveScroll();
      renderQueueTabs();
    });
    elSortBy.addEventListener("change", ()=>{
      state.filters.sortBy = elSortBy.value;
      save();
      renderTicketsPreserveScroll();
      renderQueueTabs();
    });
    elSoundOn.addEventListener("change", ()=>{
      state.filters.soundOn = elSoundOn.checked;
      save();
      toast("Som de notifica√ß√£o", elSoundOn.checked ? "Ativado" : "Desativado", "üîî");
    });
    elDemoSim.addEventListener("change", ()=>{
      state.filters.demoSim = elDemoSim.checked;
      save();
      toast("Simula√ß√£o (DEMO)", elDemoSim.checked ? "Ativada" : "Desativada", "üß™");
    });

    // Notification bell toggle
    elBell.addEventListener("click", ()=>{
      elNotiPanel.classList.toggle("open");
      renderNotifications();
      // se abrir, marca como "visualizado" mas n√£o precisa marcar como lido
    });
    elBtnMarkAllRead.addEventListener("click", ()=>{
      state.notifications.forEach(n => n.read = true);
      save();
      renderNotifications();
      renderBellBadge();
      toast("Notifica√ß√µes", "Marcadas como lidas.", "‚úÖ");
    });
    elBtnClearNoti.addEventListener("click", ()=>{
      state.notifications = [];
      save();
      renderNotifications();
      renderBellBadge();
      toast("Notifica√ß√µes", "Lista limpa.", "üßπ");
    });

    // close noti panel when click outside
    document.addEventListener("click", (e)=>{
      const inBell = elBell.contains(e.target);
      const inPanel = elNotiPanel.contains(e.target);
      if(!inBell && !inPanel){
        elNotiPanel.classList.remove("open");
      }
      // close filters if click outside too
      if(elFilters.classList.contains("open")){
        const inFilters = elFilters.contains(e.target) || document.getElementById("btnFilters").contains(e.target);
        if(!inFilters) elFilters.classList.remove("open");
      }
    });

    function getSelected(){
      return state.tickets.find(x=>x.id===state.selectedId) || state.tickets[0] || null;
    }

    function selectTicket(id){
      state.selectedId = id;
      const t = getSelected();
      if(t){
        t.unread = false;
        t.lastSeenMsgCount = (t.messages||[]).length;
      }
      // marca notifica√ß√µes desse ticket como lidas
      state.notifications.forEach(n => { if(n.ticketId === id) n.read = true; });
      save();
      renderAll({ keepChatScroll:false });
      scrollChatBottom();
      renderBellBadge();
      renderNotifications();
    }

    // Messaging
    const elMsgInput = document.getElementById("msgInput");
    document.getElementById("btnSend").addEventListener("click", sendMsg);
    elMsgInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") sendMsg(); });

    function sendMsg(){
      const text = (elMsgInput.value || "").trim();
      if(!text) return;
      const t = getSelected();
      if(!t) return;

      t.messages.push({ id: rid(), type:"me", text, at: Date.now() });
      t.unread = false;
      t.lastSeenMsgCount = t.messages.length;
      elMsgInput.value = "";
      save();

      renderChat();
      renderTicketsPreserveScroll();
      renderRightPanel();
      renderQueueTabs();
      scrollChatBottom();
    }

    function deleteMsg(msgId){
      const t = getSelected();
      if(!t) return;
      t.messages = (t.messages||[]).filter(m => m.id !== msgId);
      t.lastSeenMsgCount = t.messages.length;
      save();
      renderChat();
      renderTicketsPreserveScroll();
      renderRightPanel();
    }

    // Actions buttons
    document.getElementById("btnResolver").addEventListener("click", ()=>{
      const t = getSelected();
      if(!t) return;

      t.status = "paid";
      t.tags = uniqueTags([...(t.tags||[]), "ENTREGUE"]);
      t.queue = "FILA_DE_ENTREGA";
      t.unread = false;
      t.deliveredAt = Date.now();
      t.messages.push({ id: rid(), type:"sys", text:"Pedido marcado como ENTREGUE. Este chat ser√° removido automaticamente ap√≥s 1 hora." });
      t.lastSeenMsgCount = t.messages.length;

      save();
      toast("Pedido resolvido", "Marcado como ENTREGUE + movido para FILA DE ENTREGA", "‚úÖ");
      renderAll({ keepChatScroll:true });
      scrollChatBottom();
    });

    document.getElementById("btnLiberar").addEventListener("click", ()=>{
      const t = getSelected();
      if(!t) return;
      t.unread = false;
      t.messages.push({ id: rid(), type:"sys", text:"Ticket liberado para atendimento/entrega." });
      t.lastSeenMsgCount = t.messages.length;
      save();
      toast("Ticket liberado", "Aviso registrado no chat", "üü£");
      renderChat();
      renderTicketsPreserveScroll();
      renderRightPanel();
      scrollChatBottom();
    });

    // Tag add/remove
    elBtnAddTag.addEventListener("click", addTagFromInput);
    elTagInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") addTagFromInput(); });

    function addTagFromInput(){
      const raw = (elTagInput.value || "").trim();
      if(!raw) return;
      const tag = normalizeTag(raw);
      const t = getSelected();
      if(!t) return;

      const prevScroll = elTicketList.scrollTop;
      t.tags = uniqueTags([...(t.tags||[]), tag]);
      elTagInput.value = "";
      save();

      renderTagCloud();
      renderTickets();
      elTicketList.scrollTop = prevScroll;

      renderRightPanel();
      renderQueueTabs();
    }

    function removeTag(tag){
      const t = getSelected();
      if(!t) return;

      const prevScroll = elTicketList.scrollTop;
      t.tags = (t.tags||[]).filter(x => normalizeTag(x) !== normalizeTag(tag));
      save();

      renderTagCloud();
      renderTickets();
      elTicketList.scrollTop = prevScroll;

      renderRightPanel();
      renderQueueTabs();
    }

    // Filters
    function statusBadge(status){
      if(status==="paid") return ["PAGO","good"];
      if(status==="pending") return ["PENDENTE","warn"];
      if(status==="refunded") return ["REEMBOLSADO","good"];
      if(status==="canceled") return ["CANCELADO","bad"];
      return ["‚Äî",""];
    }

    function passesFilters(t){
      const f = state.filters;
      if(f.queue !== "all" && t.queue !== f.queue) return false;
      if(f.status !== "all" && t.status !== f.status) return false;
      if(f.tag !== "all"){
        const tags = (t.tags||[]).map(normalizeTag);
        if(!tags.includes(normalizeTag(f.tag))) return false;
      }
      if(f.onlyUnread && !t.unread) return false;
      if(f.onlyMine && !t.mine) return false;

      const q = (f.search||"").trim().toLowerCase();
      if(q){
        const hay = [t.name, t.user, t.category, t.item, t.queue, (t.tags||[]).join(" ")].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    }

    function sortTickets(arr){
      const f = state.filters;
      const copy = [...arr];
      copy.sort((a,b)=>{
        if(f.sortBy==="old") return a.createdAt - b.createdAt;
        return b.createdAt - a.createdAt;
      });
      return copy;
    }

    function getVisibleTickets(){ return sortTickets(state.tickets.filter(passesFilters)); }

    function getSnippet(t){
      const msgs = t.messages || [];
      const last = [...msgs].reverse().find(m => m.type !== "sys");
      if(!last) return "Sem mensagens.";
      return (last.type==="me" ? "Voc√™: " : "") + last.text.slice(0,90);
    }

    function renderQueueTabs(){
      const counts = countQueuesWithCurrentFilters();
      elQueueTabs.innerHTML = "";
      QUEUES.forEach(q=>{
        const btn = document.createElement("div");
        btn.className = "qtab" + (state.filters.queue===q.id ? " active" : "");
        btn.addEventListener("click", ()=>{
          state.filters.queue = q.id;
          save();
          renderAll({ keepChatScroll:true });
        });
        const label = document.createElement("span");
        label.textContent = q.label;
        const badge = document.createElement("span");
        badge.className = "qbadge";
        badge.textContent = String(counts[q.id] ?? 0);
        btn.appendChild(label);
        btn.appendChild(badge);
        elQueueTabs.appendChild(btn);
      });
    }

    function passesFiltersWith(filters, t){
      const f = filters;
      if(f.status !== "all" && t.status !== f.status) return false;
      if(f.tag !== "all"){
        const tags = (t.tags||[]).map(normalizeTag);
        if(!tags.includes(normalizeTag(f.tag))) return false;
      }
      if(f.onlyUnread && !t.unread) return false;
      if(f.onlyMine && !t.mine) return false;
      const q = (f.search||"").trim().toLowerCase();
      if(q){
        const hay = [t.name, t.user, t.category, t.item, t.queue, (t.tags||[]).join(" ")].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    }

    function countQueuesWithCurrentFilters(){
      const f = state.filters;
      const counts = {};
      QUEUES.forEach(q => counts[q.id]=0);

      state.tickets.forEach(t=>{
        const temp = { ...f, queue:"all" };
        if(!passesFiltersWith(temp, t)) return;
        counts["all"]++;
        counts[t.queue] = (counts[t.queue]||0) + 1;
      });

      return counts;
    }

    function renderStatusPills(){
      elStatusPills.innerHTML = "";
      STATUS.forEach(s=>{
        const pill = document.createElement("div");
        pill.className = "pill" + (state.filters.status===s.id ? " active" : "");
        pill.textContent = s.label;
        pill.addEventListener("click", ()=>{
          state.filters.status = s.id;
          save();
          renderAll({ keepChatScroll:true });
        });
        elStatusPills.appendChild(pill);
      });
    }

    function getAllTags(){
      const set = new Set();
      state.tickets.forEach(t => (t.tags||[]).forEach(tag=>set.add(normalizeTag(tag))));
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function renderTagCloud(){
      const tags = getAllTags();
      elTagCloud.innerHTML = "";

      const all = document.createElement("div");
      all.className = "tag" + (state.filters.tag==="all" ? " active" : "");
      all.textContent = "Todas";
      all.addEventListener("click", ()=>{
        state.filters.tag = "all";
        save();
        renderAll({ keepChatScroll:true });
      });
      elTagCloud.appendChild(all);

      tags.forEach(tag=>{
        const t = document.createElement("div");
        t.className = "tag" + (state.filters.tag===tag ? " active" : "");
        t.textContent = tag;
        t.addEventListener("click", ()=>{
          state.filters.tag = tag;
          save();
          renderAll({ keepChatScroll:true });
        });
        elTagCloud.appendChild(t);
      });
    }

    function renderTickets(){
      const tickets = getVisibleTickets();
      elTicketList.innerHTML = "";

      tickets.forEach(t=>{
        const wrap = document.createElement("div");
        wrap.className = "ticket" + (t.id===state.selectedId ? " active" : "");
        wrap.addEventListener("click", ()=>selectTicket(t.id));

        const [label, cls] = statusBadge(t.status);

        const top = document.createElement("div");
        top.className = "ticket__top";

        const name = document.createElement("div");
        name.className = "ticket__name";
        name.textContent = t.name;

        const meta = document.createElement("div");
        meta.className = "ticket__meta";

        if(t.unread){
          const dot = document.createElement("span");
          dot.className = "unreadDot";
          meta.appendChild(dot);
        }

        const badge = document.createElement("span");
        badge.className = "badge " + cls;
        badge.textContent = label;

        const small = document.createElement("span");
        small.textContent = t.queue;

        meta.appendChild(badge);
        meta.appendChild(small);

        top.appendChild(name);
        top.appendChild(meta);

        const snippet = document.createElement("div");
        snippet.className = "ticket__snippet";
        snippet.textContent = getSnippet(t);

        const tags = document.createElement("div");
        tags.className = "ticket__tags";

        (t.tags||[]).slice(0,3).forEach(tag=>{
          const tg = document.createElement("div");
          tg.className = "tag";
          tg.textContent = normalizeTag(tag);
          tg.addEventListener("click", (e)=>{
            e.stopPropagation();
            state.filters.tag = normalizeTag(tag);
            save();
            renderAll({ keepChatScroll:true });
          });
          tags.appendChild(tg);
        });

        wrap.appendChild(top);
        wrap.appendChild(snippet);
        if((t.tags||[]).length) wrap.appendChild(tags);

        elTicketList.appendChild(wrap);
      });

      const hasSelected = tickets.some(t=>t.id===state.selectedId);
      if(!hasSelected && tickets.length){
        state.selectedId = tickets[0].id;
        save();
      }

      if(!tickets.length){
        const empty = document.createElement("div");
        empty.style.padding = "18px";
        empty.className = "muted";
        empty.textContent = "Nenhum ticket encontrado com esses filtros.";
        elTicketList.appendChild(empty);
      }
    }

    function renderTicketsPreserveScroll(){
      const prev = elTicketList.scrollTop;
      renderTickets();
      elTicketList.scrollTop = prev;
    }

    function formatTime(ts){
      try{
        const d = new Date(ts);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }catch{ return ""; }
    }

    function renderChat(){
      const t = getSelected();
      if(!t){ elChat.innerHTML=""; return; }

      elChat.innerHTML = "";
      const sysTop = (t.messages||[]).find(m => m.type==="sys");
      elBanner.textContent = sysTop ? sysTop.text : "Ticket aberto.";

      (t.messages||[]).forEach(m=>{
        if(m.type==="sys"){
          const row = document.createElement("div");
          row.className = "sys";
          const b = document.createElement("div");
          b.className = "sys__bubble";
          b.textContent = m.text;
          row.appendChild(b);
          elChat.appendChild(row);
          return;
        }

        const row = document.createElement("div");
        row.className = "msgRow" + (m.type==="me" ? " me" : "");
        const bubble = document.createElement("div");
        bubble.className = "bubble" + (m.type==="me" ? " me" : "");
        bubble.textContent = m.text;

        const meta = document.createElement("div");
        meta.className = "meta";

        if(m.type==="me"){
          const del = document.createElement("button");
          del.className = "delBtn";
          del.type = "button";
          del.textContent = "APAGAR";
          del.addEventListener("click", (e)=>{
            e.stopPropagation();
            deleteMsg(m.id);
          });
          meta.appendChild(del);
        }

        const time = document.createElement("span");
        time.textContent = formatTime(m.at || t.createdAt);
        meta.appendChild(time);

        bubble.appendChild(meta);
        row.appendChild(bubble);
        elChat.appendChild(row);
      });
    }

    function scrollChatBottom(){ elChat.scrollTop = elChat.scrollHeight; }

    function hashId(id){
      const s = "4c6b26f3a71e" + id.replace(/\D/g,"");
      return s.slice(0,12) + "-4...";
    }

    function renderRightPanel(){
      const t = getSelected();
      if(!t){ elPanelBody.innerHTML=""; return; }

      document.getElementById("statSpent").textContent = String(t.spent ?? 13);
      document.getElementById("statOrders").textContent = String(t.orders ?? 1);
      document.getElementById("statItems").textContent = String(t.items ?? 1);

      const activeTab = document.querySelector(".tab.active")?.dataset?.tab || "info";

      if(activeTab === "info"){
        elPanelBody.innerHTML = `
          <div class="row"><div class="k">Fila</div><div class="v">${t.queue}</div></div>
          <div class="row"><div class="k">Categoria</div><div class="v">${t.category}</div></div>
          <div class="row"><div class="k">Data</div><div class="v">${new Date(t.createdAt).toLocaleString("pt-BR")}</div></div>
          <div class="row"><div class="k">ID Pedido</div><div class="v">${hashId(t.id)}</div></div>
          <div class="row"><div class="k">Valor Total</div><div class="v" style="color:${t.status==="paid" ? "var(--good)" : "rgba(255,255,255,.9)"}">${t.total}</div></div>
          <div class="row"><div class="k">Nickname Roblox</div><div class="v">${t.nick}</div></div>
          <div class="row"><div class="k">Link da Gamepass</div><div class="v">${t.gamepass && t.gamepass!=="-" ? `<a class="v link" href="${t.gamepass}" target="_blank" rel="noreferrer">${t.gamepass}</a>` : "-"}</div></div>
          <div class="row"><div class="k">Item</div><div class="v">${t.item}</div></div>
          <div class="row"><div class="k">Cliente</div><div class="v">${t.client}${t.clientEmail && t.clientEmail!=="-" ? ` <span class="muted">(${t.clientEmail})</span>` : ""}</div></div>
        `;
      } else if(activeTab === "items"){
        elPanelBody.innerHTML = `
          <div class="row"><div class="k">Item</div><div class="v">${t.item}</div></div>
          <div class="row"><div class="k">Categoria</div><div class="v">${t.category}</div></div>
          <div class="row"><div class="k">Status</div><div class="v">${statusBadge(t.status)[0]}</div></div>
          <div class="row"><div class="k">Fila</div><div class="v">${t.queue}</div></div>
          <div class="row"><div class="k">Quantidade</div><div class="v">1</div></div>
        `;
      } else {
        elPanelBody.innerHTML = `
          <div class="row"><div class="k">Mover para fila</div><div class="v"></div></div>
          <select id="queueSelect" class="select" style="margin-top:6px">
            ${QUEUES.filter(q=>q.id!=="all").map(q=>`<option value="${q.id}" ${q.id===t.queue?"selected":""}>${q.label}</option>`).join("")}
          </select>

          <div class="row" style="margin-top:12px"><div class="k">Notificar cliente</div><div class="v"></div></div>
          <div class="muted">E-mail aqui √© DEMO. Para e-mail real precisa backend.</div>
          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
            <button class="btn small ghost" id="btnEmail">ENVIAR E-MAIL</button>
            <button class="btn small" id="btnPing">NOTIFICA√á√ÉO (DEMO)</button>
          </div>
        `;

        const qs = document.getElementById("queueSelect");
        qs.addEventListener("change", ()=>{
          const nv = qs.value;
          t.queue = nv;
          t.tags = uniqueTags([...(t.tags||[]), nv]);
          save();
          toast("Fila atualizada", `Ticket movido para: ${nv}`, "üì¶");
          renderTicketsPreserveScroll();
          renderQueueTabs();
          renderTagCloud();
        });

        document.getElementById("btnEmail").addEventListener("click", ()=>{
          const email = t.clientEmail && t.clientEmail !== "-" ? t.clientEmail : null;
          if(!email){
            toast("E-mail indispon√≠vel", "Este ticket n√£o tem e-mail cadastrado.", "‚úâÔ∏è");
            return;
          }
          toast("E-mail (DEMO)", `Simulando envio para ${email}`, "üì®");
          t.messages.push({ id: rid(), type:"sys", text:`(DEMO) E-mail enviado para o cliente: ${email}` });
          t.lastSeenMsgCount = t.messages.length;
          save();
          renderChat();
          scrollChatBottom();
        });

        document.getElementById("btnPing").addEventListener("click", ()=>{
          toast("Notifica√ß√£o (DEMO)", "Simulando lembrete tipo bot do Discord.", "ü§ñ");
        });
      }

      // Ticket tags
      elTicketTags.innerHTML = "";
      (t.tags || []).forEach(tag=>{
        const tg = document.createElement("div");
        tg.className = "tag removable";
        tg.textContent = normalizeTag(tag);
        tg.title = "Clique para remover";
        tg.addEventListener("click", ()=> removeTag(tag));
        elTicketTags.appendChild(tg);
      });

      if(!(t.tags||[]).length){
        const none = document.createElement("div");
        none.className = "muted";
        none.textContent = "Sem tags ainda.";
        elTicketTags.appendChild(none);
      }
    }

    // Toast
    function toast(title, msg, icon="üü£"){
      const t = document.createElement("div");
      t.className = "toast";
      t.innerHTML = `
        <div class="ticon">${icon}</div>
        <div>
          <div><b>${escapeHtml(title)}</b></div>
          <div class="tmeta">${escapeHtml(msg)}</div>
        </div>
      `;
      elToasts.appendChild(t);

      setTimeout(()=> {
        t.style.opacity = "0";
        t.style.transform = "translateY(-6px)";
        t.style.transition = "all .18s ease";
        setTimeout(()=> t.remove(), 220);
      }, 1900);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function playBeep(){
      if(!state.filters.soundOn) return;
      try{
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 740;
        g.gain.value = 0.05;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 110);
      }catch{}
    }

    // Notification center
    function addNotification(ticket, msgText){
      const notif = {
        id: rid(),
        ticketId: ticket.id,
        name: ticket.name,
        text: msgText,
        at: Date.now(),
        read: false
      };
      state.notifications.unshift(notif);
      // cap size
      if(state.notifications.length > 80) state.notifications = state.notifications.slice(0,80);
    }

    function renderBellBadge(){
      const unread = state.notifications.filter(n => !n.read).length;
      if(unread > 0){
        elBellBadge.style.display = "flex";
        elBellBadge.textContent = String(Math.min(unread, 99));
      }else{
        elBellBadge.style.display = "none";
      }
    }

    function renderNotifications(){
      renderBellBadge();
      elNotiList.innerHTML = "";

      if(!state.notifications.length){
        const d = document.createElement("div");
        d.className = "notiEmpty";
        d.textContent = "Sem notifica√ß√µes.";
        elNotiList.appendChild(d);
        return;
      }

      state.notifications.forEach(n=>{
        const item = document.createElement("div");
        item.className = "notiItem";
        item.addEventListener("click", ()=>{
          n.read = true;
          save();
          selectTicket(n.ticketId);
          elNotiPanel.classList.remove("open");
        });

        const dot = document.createElement("div");
        dot.className = "notiDot";
        dot.style.opacity = n.read ? "0" : "1";

        const txt = document.createElement("div");
        txt.className = "notiText";
        txt.innerHTML = `<b>${escapeHtml(n.name)}</b> ‚Ä¢ ${escapeHtml(n.text.slice(0,80))}`;

        const meta = document.createElement("div");
        meta.className = "notiMeta";
        meta.textContent = new Date(n.at).toLocaleString("pt-BR");

        const wrap = document.createElement("div");
        wrap.appendChild(txt);
        wrap.appendChild(meta);

        item.appendChild(dot);
        item.appendChild(wrap);

        elNotiList.appendChild(item);
      });
    }

    // Auto-remove delivered
    function cleanupDelivered(){
      const before = state.tickets.length;
      const now = Date.now();
      state.tickets = state.tickets.filter(t=>{
        if(t.status !== "paid") return true;
        const hasEntregue = (t.tags||[]).map(normalizeTag).includes("ENTREGUE");
        if(!hasEntregue) return true;
        if(!t.deliveredAt) return true;
        return (now - t.deliveredAt) < AUTO_REMOVE_DELIVERED_MS;
      });

      const after = state.tickets.length;
      if(after !== before){
        const still = state.tickets.some(x=>x.id===state.selectedId);
        if(!still) state.selectedId = state.tickets[0]?.id || null;
        save();
        renderAll({ keepChatScroll:true });
      }
    }

    // Anti-spam detection of new customer messages
    function detectNewCustomerMessages(){
      const selected = getSelected();

      state.tickets.forEach(t=>{
        const msgCount = (t.messages||[]).length;
        const lastNotified = t.lastNotifiedCount || 0;

        if(msgCount > lastNotified){
          const newMsgs = t.messages.slice(lastNotified);
          const latestThem = [...newMsgs].reverse().find(m => m.type === "them");
          if(latestThem){
            // mark ticket unread unless currently open
            const isOpen = selected && selected.id === t.id;
            if(!isOpen){
              t.unread = true;

              // Add to notification center ONCE per new message batch
              addNotification(t, latestThem.text);

              // Light toast only (1) + optional sound
              toast("Cliente respondeu", `${t.name}: ${latestThem.text.slice(0,64)}`, "üí¨");
              playBeep();
            }
          }

          // update lastNotifiedCount so it doesn't spam
          t.lastNotifiedCount = msgCount;

          // if open ticket, consider read
          if(selected && selected.id === t.id){
            t.unread = false;
            t.lastSeenMsgCount = msgCount;
          }
        }
      });

      renderBellBadge();
      save();
    }

    // DEMO simulate
    const SIM_REPLIES = [
      "Oi, t√¥ aqui! Conseguiu ver?",
      "Eu mandei o link agora, confere por favor",
      "Tem previs√£o de entrega?",
      "Meu nick √© esse mesmo, t√° certo?",
      "Se precisar eu mando print",
      "Conseguiu achar a gamepass?",
      "Posso esperar, s√≥ me avisa aqui",
      "Opa, respondi no discord tamb√©m",
    ];

    function simulateIncoming(){
      if(!state.filters.demoSim) return;
      if(Math.random() > SIMULATE_REPLY_PROB) return;

      const candidates = state.tickets.filter(t => t.status === "pending");
      if(!candidates.length) return;

      const t = candidates[Math.floor(Math.random()*candidates.length)];
      const txt = SIM_REPLIES[Math.floor(Math.random()*SIM_REPLIES.length)];
      t.messages.push({ id: rid(), type:"them", text: txt, at: Date.now() });
      save();
    }

    // Render all
    function renderAll({ keepChatScroll=true } = {}){
      renderQueueTabs();
      renderStatusPills();
      renderTagCloud();
      renderTicketsPreserveScroll();

      if(keepChatScroll){
        const prev = elChat.scrollTop;
        renderChat();
        elChat.scrollTop = prev;
      }else{
        renderChat();
      }

      renderRightPanel();
      renderNotifications();
    }

    // Init render
    renderAll({ keepChatScroll:false });
    setTimeout(()=> scrollChatBottom(), 60);

    // Chat click marks read
    elChat.addEventListener("click", ()=>{
      const t = getSelected();
      if(!t) return;
      t.unread = false;
      t.lastSeenMsgCount = (t.messages||[]).length;
      // mark notifications of this ticket read
      state.notifications.forEach(n => { if(n.ticketId === t.id) n.read = true; });
      save();
      renderTicketsPreserveScroll();
      renderQueueTabs();
      renderBellBadge();
      renderNotifications();
    });

    // Auto-refresh loop
    setInterval(()=>{
      cleanupDelivered();
      simulateIncoming();
      detectNewCustomerMessages();

      // fast repaint (preserve scroll)
      const listScroll = elTicketList.scrollTop;
      const chatScroll = elChat.scrollTop;
      const atBottom = (elChat.scrollHeight - elChat.scrollTop - elChat.clientHeight) < 80;

      renderQueueTabs();
      renderTickets();
      elTicketList.scrollTop = listScroll;

      renderChat();
      if(atBottom) scrollChatBottom();
      else elChat.scrollTop = chatScroll;

      renderRightPanel();
      renderBellBadge();
      save();
    }, POLL_MS);
  </script>
</body>
</html>
