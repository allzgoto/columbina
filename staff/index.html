<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Panel â€” Conversas</title>
  <style>
    :root{
      --bg:#0a0b0f;
      --bg2:#0d0f15;
      --card:#0f1118;
      --card2:#0f121b;
      --stroke:rgba(255,255,255,.07);
      --text:#e9e9ee;
      --muted:#a2a2b3;
      --accent:#b300ff;         /* roxo */
      --accent2:#ff00d4;        /* pink roxo */
      --good:#33d17a;
      --warn:#f2b01e;
      --bad:#ff4d4d;
      --shadow:0 18px 60px rgba(0,0,0,.65);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 25% 10%, rgba(179,0,255,.12), transparent 60%),
        radial-gradient(900px 700px at 70% 0%, rgba(255,0,212,.08), transparent 55%),
        linear-gradient(180deg, var(--bg), #07080b);
      overflow:hidden;
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 320px 1fr 340px;
      gap:14px;
      padding:14px;
    }

    /* LEFT */
    .left{
      background: linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .left__header{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--stroke);
    }
    .brand{display:flex; gap:10px; align-items:center}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--good);
      box-shadow:0 0 0 6px rgba(51,209,122,.12);
    }
    .brand__title{font-weight:800; letter-spacing:.2px}
    .brand__sub{font-size:12px;color:var(--muted); margin-top:2px}

    .left__actions{display:flex; gap:8px}
    .iconbtn{
      width:38px;height:38px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition:transform .08s ease, background .15s ease;
    }
    .iconbtn:hover{background:rgba(255,255,255,.06)}
    .iconbtn:active{transform:translateY(1px)}

    .search{padding:10px 14px}
    .search input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .search input::placeholder{color:rgba(255,255,255,.35)}

    .list{
      padding:6px;
      overflow:auto;
      flex:1;
    }
    .ticket{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid transparent;
      background:rgba(255,255,255,.02);
      margin:6px;
      cursor:pointer;
      display:grid;
      gap:6px;
      transition:background .12s ease, border-color .12s ease;
    }
    .ticket:hover{background:rgba(255,255,255,.045)}
    .ticket.active{
      border-color:rgba(179,0,255,.35);
      background: linear-gradient(180deg, rgba(179,0,255,.12), rgba(255,0,212,.06));
    }
    .ticket__top{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .ticket__name{font-weight:800}
    .ticket__meta{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{color:var(--good); border-color:rgba(51,209,122,.25); background:rgba(51,209,122,.08)}
    .badge.warn{color:var(--warn); border-color:rgba(242,176,30,.25); background:rgba(242,176,30,.08)}
    .badge.bad{color:var(--bad); border-color:rgba(255,77,77,.25); background:rgba(255,77,77,.08)}
    .ticket__snippet{font-size:13px; color:rgba(255,255,255,.78); line-height:1.25}
    .ticket__tags{display:flex; flex-wrap:wrap; gap:6px}
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(179,0,255,.22);
      background:rgba(179,0,255,.08);
      color:rgba(255,255,255,.9);
      cursor:pointer;
      user-select:none;
    }

    /* Filters (FIX: smaller + scroll + responsive) */
    .filters{
      position:absolute;
      top:0; right:-320px;
      width:300px;
      height:100%;
      max-height:100%;
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(8,9,12,.98));
      border-left:1px solid var(--stroke);
      transition:right .22s ease;
      box-shadow:-18px 0 60px rgba(0,0,0,.55);
      padding:14px 12px;
      overflow:auto;
    }
    .filters.open{right:0}
    .filters__header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid var(--stroke);
      position:sticky;
      top:0;
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(12,14,20,.92));
      z-index:2;
      margin:-14px -12px 10px;
      padding:14px 12px 10px;
    }
    .filters__title{font-weight:900}
    .filters__section{padding:12px 0; border-bottom:1px solid rgba(255,255,255,.05)}
    .filters__label{font-size:12px; color:var(--muted); margin-bottom:10px; text-transform:uppercase; letter-spacing:.8px}
    .pillRow{display:flex; flex-wrap:wrap; gap:8px}
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
      box-shadow:0 0 0 6px rgba(179,0,255,.08);
    }
    .check{display:flex; align-items:center; gap:10px; color:rgba(255,255,255,.85); font-size:13px; margin:8px 0}
    .check input{accent-color: var(--accent)}
    .select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .tagCloud{display:flex; flex-wrap:wrap; gap:8px}
    .tagCloud .tag{
      border-color:rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.85);
    }
    .tagCloud .tag.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
    }

    /* CENTER */
    .center{
      background: linear-gradient(180deg, rgba(15,17,24,.78), rgba(8,9,12,.78));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .center__top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
    }
    .banner{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
      min-width:0;
    }
    .banner span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .spark{filter:drop-shadow(0 4px 10px rgba(255,255,255,.12))}
    .center__topRight{display:flex; gap:10px}
    .btn{
      height:38px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      letter-spacing:.4px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:active{transform:translateY(1px)}
    .btn.warn{
      border-color:rgba(242,176,30,.25);
      background:rgba(242,176,30,.08);
    }
    .btn.ghost{
      border-color:rgba(179,0,255,.25);
      background:rgba(179,0,255,.10);
    }
    .btn.small{height:34px; border-radius:12px; padding:0 12px; font-weight:800}
    .dotSmall{
      width:7px;height:7px;border-radius:50%;
      background:rgba(179,0,255,.95);
      box-shadow:0 0 0 6px rgba(179,0,255,.12);
    }

    .chatWrap{flex:1; display:flex; flex-direction:column; min-height:0}
    .chat{
      padding:18px 18px 10px;
      overflow:auto;
      flex:1;
    }
    .sys{
      width:100%;
      display:flex;
      justify-content:center;
      margin:10px 0;
    }
    .sys .sys__bubble{
      padding:10px 12px;
      max-width:820px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      color:rgba(255,255,255,.7);
      font-size:13px;
    }
    .msgRow{display:flex; margin:10px 0}
    .msgRow.me{justify-content:flex-end}
    .bubble{
      max-width:min(860px, 78%);
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.88);
      line-height:1.25;
      box-shadow:0 10px 35px rgba(0,0,0,.35);
      position:relative;
      font-size:14px;
    }
    .bubble.me{
      background:linear-gradient(180deg, rgba(179,0,255,.92), rgba(179,0,255,.70));
      border-color:rgba(255,255,255,.12);
      color:#fff;
    }
    .bubble .meta{
      margin-top:8px;
      font-size:11px;
      color:rgba(255,255,255,.75);
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }

    .composer{
      padding:12px;
      border-top:1px solid var(--stroke);
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(0,0,0,.12);
    }
    .composer input{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .send{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(179,0,255,.35);
      background:rgba(179,0,255,.18);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition:transform .08s ease, background .15s ease;
    }
    .send:hover{background:rgba(179,0,255,.25)}
    .send:active{transform:translateY(1px)}

    /* RIGHT */
    .right{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .stat{
      background:linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow:var(--shadow);
    }
    .stat__label{
      font-size:11px;
      letter-spacing:1px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .stat__value{
      margin-top:8px;
      font-size:18px;
      font-weight:900;
    }

    .panel{
      background:linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel__tabs{
      display:flex;
      border-bottom:1px solid var(--stroke);
      gap:8px;
      padding:10px;
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:800;
    }
    .tab.active{
      border-color:rgba(179,0,255,.35);
      background:rgba(179,0,255,.12);
    }
    .panel__header{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
    }
    .panel__title{font-weight:900}
    .panel__body{padding:14px}
    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .row:last-child{border-bottom:none}
    .k{color:var(--muted); font-size:12px}
    .v{font-weight:800}
    .v.link{
      color:rgba(179,0,255,.95);
      text-decoration:none;
      font-weight:900;
    }
    .v.link:hover{text-decoration:underline}
    .muted{color:rgba(255,255,255,.45); font-size:12px}

    .tagRow{display:flex; flex-wrap:wrap; gap:8px}
    .tagRow .tag{border-color:rgba(179,0,255,.25); background:rgba(179,0,255,.10)}
    .tagRow .tag.removable{
      position:relative;
      padding-right:26px;
    }
    .tagRow .tag.removable::after{
      content:"Ã—";
      position:absolute;
      right:9px; top:3px;
      opacity:.8;
      font-weight:900;
    }
    .tagAdd{
      display:flex;
      gap:8px;
      margin-top:12px;
    }
    .tagAdd input{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }

    /* Scrollbars */
    .list::-webkit-scrollbar, .chat::-webkit-scrollbar, .filters::-webkit-scrollbar{width:10px}
    .list::-webkit-scrollbar-thumb, .chat::-webkit-scrollbar-thumb, .filters::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.08);
      border:2px solid rgba(0,0,0,0);
      background-clip:padding-box;
      border-radius:999px;
    }
    .list::-webkit-scrollbar-track, .chat::-webkit-scrollbar-track, .filters::-webkit-scrollbar-track{
      background:transparent;
    }

    /* Responsive */
    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns: 320px 1fr; grid-template-rows:auto auto; height:auto}
      .right{grid-column: 1 / -1}
    }
    @media (max-width: 820px){
      body{overflow:auto}
      .app{grid-template-columns: 1fr; padding:10px}
      .left,.center,.right{border-radius:16px}
      /* filters as overlay on small screens */
      .filters{
        position:fixed;
        top:10px;
        bottom:10px;
        height:auto;
        right:-100vw;
        width:min(92vw, 360px);
        border-radius:16px;
        border:1px solid var(--stroke);
      }
      .filters.open{right:10px}
      .filters__header{
        border-top-left-radius:16px;
        border-top-right-radius:16px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <aside class="left">
      <div class="left__header">
        <div class="brand">
          <div class="dot"></div>
          <div>
            <div class="brand__title">Conversas</div>
            <div class="brand__sub">Bem-vindo(a), <b id="agentName">Allz</b></div>
          </div>
        </div>
        <div class="left__actions">
          <button class="iconbtn" id="btnFilters" title="Filtros">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="search">
        <input id="searchInput" type="text" placeholder="Pesquisar..." />
      </div>

      <div class="list" id="ticketList"></div>

      <div class="filters" id="filters">
        <div class="filters__header">
          <div class="filters__title">Filtros</div>
          <button class="iconbtn" id="btnCloseFilters" title="Fechar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <div class="filters__section">
          <div class="filters__label">Status pagamento</div>
          <div class="pillRow" id="statusPills"></div>
        </div>

        <div class="filters__section">
          <label class="check">
            <input type="checkbox" id="onlyUnread" />
            <span>Apenas nÃ£o lidos</span>
          </label>
          <label class="check">
            <input type="checkbox" id="onlyMine" />
            <span>Meus tickets</span>
          </label>
        </div>

        <div class="filters__section">
          <div class="filters__label">Ordenar por</div>
          <select id="sortBy" class="select">
            <option value="recent">Mais recentes</option>
            <option value="old">Mais antigos</option>
          </select>
        </div>

        <div class="filters__section">
          <div class="filters__label">Filtrar por Tag</div>
          <div class="tagCloud" id="tagCloud"></div>
          <div class="muted" style="margin-top:8px">
            *Tags aparecem conforme vocÃª adiciona nos tickets.
          </div>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div class="center__top">
        <div class="banner">
          <span class="spark">ðŸŽ‰</span>
          <span id="bannerText">Pagamento confirmado! Seu pedido estÃ¡ sendo processado...</span>
        </div>

        <div class="center__topRight">
          <button class="btn ghost" id="btnLiberar"><span class="dotSmall"></span>LIBERAR</button>
          <button class="btn warn" id="btnResolver">RESOLVER</button>
        </div>
      </div>

      <div class="chatWrap">
        <div class="chat" id="chat"></div>

        <div class="composer">
          <input id="msgInput" type="text" placeholder="Digite sua mensagem..." />
          <button class="send" id="btnSend" title="Enviar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M22 2L15 22l-4-9-9-4L22 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="right">
      <div class="stats">
        <div class="stat">
          <div class="stat__label">GASTOS</div>
          <div class="stat__value">R$ <span id="statSpent">13</span></div>
        </div>
        <div class="stat">
          <div class="stat__label">PEDIDOS</div>
          <div class="stat__value" id="statOrders">1</div>
        </div>
        <div class="stat">
          <div class="stat__label">ITENS</div>
          <div class="stat__value" id="statItems">1</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel__tabs">
          <button class="tab active" data-tab="info">Info</button>
          <button class="tab" data-tab="items">Items</button>
          <button class="tab" data-tab="actions">AÃ§Ãµes</button>
        </div>
        <div class="panel__body" id="panelBody"></div>
      </div>

      <div class="panel">
        <div class="panel__header"><div class="panel__title">Tags do Ticket</div></div>
        <div class="panel__body">
          <div class="tagRow" id="ticketTags"></div>

          <div class="tagAdd">
            <input id="tagInput" type="text" placeholder="Adicionar tag (ex: MM2, ENTREGUE, BUG...)" />
            <button class="btn small" id="btnAddTag">Adicionar</button>
          </div>

          <div class="muted" style="margin-top:10px">
            Dica: clique em uma tag aqui ou no filtro para filtrar.
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    /***************
     * Simple Staff Panel (single-file)
     * - Fake tickets + chat
     * - Tags per ticket (persisted)
     * - Filter by status, tag, unread, mine, search, sort
     * - No reset: localStorage
     ***************/

    const LS_KEY = "staff_panel_v2";
    const AGENT = "Allz";

    const STATUS = [
      { id:"all", label:"Todos" },
      { id:"paid", label:"Pagos" },
      { id:"pending", label:"Pendentes" },
      { id:"refunded", label:"Reembolsados" },
      { id:"canceled", label:"Cancelados" },
    ];

    function nowMinusMinutes(m){
      return Date.now() - (m*60*1000);
    }

    function normalizeTag(tag){
      return String(tag).trim().toUpperCase().replace(/\s+/g,"_");
    }
    function uniqueTags(arr){
      const set = new Set(arr.map(normalizeTag));
      return Array.from(set);
    }

    function generateExtraTickets(count){
      const names = ["ThayS","Nina","Renan","Bryan","Laura","LetÃ­cia","Paulo","Yasmim","Brenda","Miguel","Gabi","Rafa","Davi","Malu","Caio","Luan","Iza","Noah","Bia","Hugo"];
      const users = ["thaysw0","ninaz","renan_77","bryanbr","laura_s","leticia_m","paulo00","yas_kk","brendaX","migrez","gabi_13","rafaelo","davi_x","maluzita","caio_rbx","luanbr","iza_rob","noahdev","bianca2","hugoz"];
      const categories = ["MM2","ROBUX_GAMEPASS","MM2","MM2","ROBUX_GAMEPASS"];
      const items = ["MM2 â€” Godly","MM2 â€” Pacote","300 Robux (via Gamepass)","500 Robux (via Gamepass)","MM2 â€” Item avulso"];
      const tagsPool = ["MM2","GAMEPASS","ENTREGUE","REEMBOLSO","MUDAR_TAG","URGENTE","BUG","FALTA_LINK","PAGAMENTO","DÃšVIDA"];
      const statuses = ["pending","paid","refunded","canceled"];

      const out = [];
      for(let i=0;i<count;i++){
        const idx = i % names.length;
        const status = statuses[i % statuses.length];
        const cat = categories[i % categories.length];
        const tagA = tagsPool[(i*3) % tagsPool.length];
        const tagB = tagsPool[(i*3 + 2) % tagsPool.length];

        const id = "tx" + (i+1);
        const createdAt = nowMinusMinutes(170 + i*9);
        const unread = (i % 3) !== 0;
        const mine = (i % 4) === 0;

        const item = items[i % items.length];
        const nick = users[idx];

        out.push({
          id,
          name: names[idx],
          user: users[idx],
          createdAt,
          unread,
          mine,
          status,
          category: cat,
          total: "R$ " + (10 + (i%7)*3) + ",90",
          nick,
          gamepass: cat === "ROBUX_GAMEPASS" ? "https://www.roblox.com/game-pass/123456" + (100+i) : "-",
          item,
          client: names[idx],
          clientEmail: "-",
          spent: 10 + (i%7)*3,
          orders: 1,
          items: 1,
          tags: uniqueTags([tagA, tagB, cat]),
          messages: [
            { type:"sys", text: "Ticket criado no sistema." },
            ...(mine ? [{ type:"sys", text: AGENT + " assumiu este atendimento." }] : []),
            { type:"them", text: cat==="ROBUX_GAMEPASS" ? "Opa, onde envio o link da gamepass?" : "Oi, quando entrega meu item?", at: createdAt + 2*60*1000 },
            ...(status==="paid" ? [{ type:"me", text:"Entregue âœ… qualquer coisa chama!", at: createdAt + 6*60*1000 }] : []),
            ...(status==="refunded" ? [{ type:"me", text:"Reembolso processado. ðŸ’œ", at: createdAt + 6*60*1000 }] : []),
            ...(status==="canceled" ? [{ type:"me", text:"Pedido cancelado conforme solicitado.", at: createdAt + 6*60*1000 }] : []),
          ]
        });
      }
      return out;
    }

    const seedData = () => {
      const baseTickets = [
        {
          id:"t1",
          name:"Kamila",
          user:"Wzkamila",
          createdAt: nowMinusMinutes(35),
          unread:true,
          mine:true,
          status:"pending",
          category:"ROBUX_GAMEPASS",
          total:"R$ 12,60",
          nick:"revoltadinha13",
          gamepass:"https://www.roblox.com/game-pass/1573179189",
          item:"300 Robux (via Gamepass)",
          client:"Esmeralda",
          clientEmail:"cm5592521@gmail.com",
          spent:13, orders:1, items:1,
          tags:["MM2","GAMEPASS"],
          messages: [
            { type:"sys", text:"ðŸŽ‰ Pagamento confirmado! Seu pedido estÃ¡ sendo processado. Nossa equipe entrarÃ¡ em contato em breve para realizar a entrega." },
            { type:"sys", text:"Allz assumiu este atendimento." },
            { type:"me", text:"OlÃ¡! Muito obrigado pela sua compra, caso tenha alguma dÃºvida, pode me informar aqui ou lÃ¡ no discord, abrindo suporte. Entregaremos o mais rÃ¡pido possÃ­vel, ainda hoje! ðŸ’œ", at: nowMinusMinutes(30)},
            { type:"me", text:"Verifiquei que ainda nÃ£o enviou sua gamepass, precisa de ajuda com isso? Caso ela apenas nÃ£o tenha sido encontrada, vÃ¡ em \"minhas compras\" e selecione a compra que estÃ¡ tendo problemas, apÃ³s isso Ã© sÃ³ clicar em \"inserir link manualmente\" e colocar o link de sua gamepass! Lembre-se de desativar os preÃ§os regionais.", at: nowMinusMinutes(28)},
          ]
        },
        {
          id:"t2",
          name:"Lipe nuts",
          user:"lipezzk077",
          createdAt: nowMinusMinutes(55),
          unread:false,
          mine:false,
          status:"paid",
          category:"MM2",
          total:"R$ 49,90",
          nick:"lipezzk077",
          gamepass:"-",
          item:"MM2 â€” Pacote",
          client:"Lipe",
          clientEmail:"-",
          spent:49.9, orders:1, items:1,
          tags:["ENTREGUE","MM2"],
          messages: [
            { type:"sys", text:"Pagamento confirmado! Pedido liberado para entrega." },
            { type:"me", text:"Pedido recebido! JÃ¡ estou separando seu item. âœ…", at: nowMinusMinutes(52)},
            { type:"them", text:"Opa, beleza! Valeu", at: nowMinusMinutes(51)},
            { type:"me", text:"Entregue! Se precisar de algo, chama. ðŸ’œ", at: nowMinusMinutes(50)},
          ]
        },
        {
          id:"t3",
          name:"DUDAXLSANTOS",
          user:"DUDAXLSANTOS",
          createdAt: nowMinusMinutes(80),
          unread:true,
          mine:true,
          status:"pending",
          category:"ROBUX_GAMEPASS",
          total:"R$ 25,00",
          nick:"dudaxl",
          gamepass:"https://www.roblox.com/game-pass/123456789",
          item:"500 Robux (via Gamepass)",
          client:"Duda",
          clientEmail:"-",
          spent:25, orders:1, items:1,
          tags:["GAMEPASS"],
          messages: [
            { type:"sys", text:"Pagamento confirmado! Seu pedido estÃ¡ sendo processado." },
            { type:"sys", text:"Allz assumiu este atendimento." },
            { type:"them", text:"Oi, eu nÃ£o achei onde manda o link", at: nowMinusMinutes(78)},
          ]
        },
        {
          id:"t4",
          name:"w1s.",
          user:"southnak",
          createdAt: nowMinusMinutes(110),
          unread:true,
          mine:false,
          status:"pending",
          category:"MM2",
          total:"R$ 19,90",
          nick:"southnak",
          gamepass:"-",
          item:"MM2 â€” Item avulso",
          client:"w1s",
          clientEmail:"-",
          spent:19.9, orders:1, items:1,
          tags:["MM2","MUDAR_TAG"],
          messages: [
            { type:"sys", text:"Pedido em anÃ¡lise." },
            { type:"them", text:"Meu ticket tÃ¡ sem tag, pode arrumar?", at: nowMinusMinutes(108)},
          ]
        },
        {
          id:"t5",
          name:"b.ferrazxl",
          user:"brunoteixeiraferrazferraz@gmail.com",
          createdAt: nowMinusMinutes(140),
          unread:false,
          mine:false,
          status:"refunded",
          category:"MM2",
          total:"R$ 12,00",
          nick:"brunoteixeira",
          gamepass:"-",
          item:"MM2 â€” Item",
          client:"Bruno",
          clientEmail:"brunoteixeiraferrazferraz@gmail.com",
          spent:12, orders:1, items:1,
          tags:["REEMBOLSO","MM2"],
          messages: [
            { type:"sys", text:"Reembolso processado." },
            { type:"me", text:"Reembolso concluÃ­do. ðŸ’œ", at: nowMinusMinutes(138)},
          ]
        },
      ];

      const extra = generateExtraTickets(15);
      return {
        me: AGENT,
        selectedId: "t1",
        filters: {
          status: "all",
          tag: "all",
          onlyUnread: false,
          onlyMine: false,
          sortBy: "recent",
          search: ""
        },
        tickets: baseTickets.concat(extra)
      };
    };

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return seedData();
        const parsed = JSON.parse(raw);
        if(!parsed.tickets || !Array.isArray(parsed.tickets)) return seedData();
        return parsed;
      }catch{
        return seedData();
      }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = load();

    // Elements
    const elTicketList = document.getElementById("ticketList");
    const elChat = document.getElementById("chat");
    const elPanelBody = document.getElementById("panelBody");
    const elTicketTags = document.getElementById("ticketTags");
    const elTagInput = document.getElementById("tagInput");
    const elBtnAddTag = document.getElementById("btnAddTag");
    const elSearch = document.getElementById("searchInput");
    const elOnlyUnread = document.getElementById("onlyUnread");
    const elOnlyMine = document.getElementById("onlyMine");
    const elSortBy = document.getElementById("sortBy");
    const elStatusPills = document.getElementById("statusPills");
    const elTagCloud = document.getElementById("tagCloud");
    const elBanner = document.getElementById("bannerText");

    // Filters drawer
    const elFilters = document.getElementById("filters");
    document.getElementById("btnFilters").addEventListener("click", () => elFilters.classList.add("open"));
    document.getElementById("btnCloseFilters").addEventListener("click", () => elFilters.classList.remove("open"));
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") elFilters.classList.remove("open");
    });

    // Tabs
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        renderRightPanel();
      });
    });

    // Status pills
    function renderStatusPills(){
      elStatusPills.innerHTML = "";
      STATUS.forEach(s=>{
        const pill = document.createElement("div");
        pill.className = "pill" + (state.filters.status===s.id ? " active" : "");
        pill.textContent = s.label;
        pill.addEventListener("click", ()=>{
          state.filters.status = s.id;
          save();
          renderAll();
        });
        elStatusPills.appendChild(pill);
      });
    }

    function getAllTags(){
      const set = new Set();
      state.tickets.forEach(t => (t.tags||[]).forEach(tag=>set.add(normalizeTag(tag))));
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function renderTagCloud(){
      const tags = getAllTags();
      elTagCloud.innerHTML = "";

      const all = document.createElement("div");
      all.className = "tag" + (state.filters.tag==="all" ? " active" : "");
      all.textContent = "Todas";
      all.addEventListener("click", ()=>{
        state.filters.tag = "all";
        save();
        renderAll();
      });
      elTagCloud.appendChild(all);

      tags.forEach(tag=>{
        const t = document.createElement("div");
        t.className = "tag" + (state.filters.tag===tag ? " active" : "");
        t.textContent = tag;
        t.addEventListener("click", ()=>{
          state.filters.tag = tag;
          save();
          renderAll();
        });
        elTagCloud.appendChild(t);
      });
    }

    // Inputs (persist)
    elSearch.value = state.filters.search || "";
    elOnlyUnread.checked = !!state.filters.onlyUnread;
    elOnlyMine.checked = !!state.filters.onlyMine;
    elSortBy.value = state.filters.sortBy || "recent";

    elSearch.addEventListener("input", (e)=>{
      state.filters.search = e.target.value;
      save();
      renderTickets();
    });

    elOnlyUnread.addEventListener("change", ()=>{
      state.filters.onlyUnread = elOnlyUnread.checked;
      save();
      renderTickets();
    });

    elOnlyMine.addEventListener("change", ()=>{
      state.filters.onlyMine = elOnlyMine.checked;
      save();
      renderTickets();
    });

    elSortBy.addEventListener("change", ()=>{
      state.filters.sortBy = elSortBy.value;
      save();
      renderTickets();
    });

    // Messaging
    const elMsgInput = document.getElementById("msgInput");
    document.getElementById("btnSend").addEventListener("click", sendMsg);
    elMsgInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") sendMsg();
    });

    function sendMsg(){
      const text = (elMsgInput.value || "").trim();
      if(!text) return;

      const t = getSelected();
      t.messages.push({ type:"me", text, at: Date.now() });
      t.unread = false;
      elMsgInput.value = "";
      save();
      renderAll();
      scrollChatBottom();
    }

    // Actions buttons
    document.getElementById("btnResolver").addEventListener("click", ()=>{
      const t = getSelected();
      t.status = "paid";
      t.tags = uniqueTags([...(t.tags||[]), "ENTREGUE"]);
      t.unread = false;
      save();
      renderAll();
    });
    document.getElementById("btnLiberar").addEventListener("click", ()=>{
      const t = getSelected();
      t.unread = false;
      t.messages.push({ type:"sys", text:"Ticket liberado para atendimento/entrega." });
      save();
      renderAll();
      scrollChatBottom();
    });

    // Tag add/remove
    elBtnAddTag.addEventListener("click", addTagFromInput);
    elTagInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") addTagFromInput();
    });

    function addTagFromInput(){
      const raw = (elTagInput.value || "").trim();
      if(!raw) return;
      const tag = normalizeTag(raw);

      const t = getSelected();
      t.tags = uniqueTags([...(t.tags||[]), tag]);
      elTagInput.value = "";
      save();
      renderAll();
    }

    function removeTag(tag){
      const t = getSelected();
      t.tags = (t.tags||[]).filter(x => normalizeTag(x) !== normalizeTag(tag));
      save();
      renderAll();
    }

    function getSelected(){
      return state.tickets.find(x=>x.id===state.selectedId) || state.tickets[0];
    }

    function selectTicket(id){
      state.selectedId = id;
      const t = getSelected();
      t.unread = false;
      save();
      renderAll();
      scrollChatBottom();
    }

    function statusBadge(status){
      if(status==="paid") return ["PAGO","good"];
      if(status==="pending") return ["PENDENTE","warn"];
      if(status==="refunded") return ["REEMBOLSADO","good"];
      if(status==="canceled") return ["CANCELADO","bad"];
      return ["â€”",""];
    }

    function passesFilters(t){
      const f = state.filters;

      if(f.status !== "all" && t.status !== f.status) return false;

      if(f.tag !== "all"){
        const tags = (t.tags||[]).map(normalizeTag);
        if(!tags.includes(normalizeTag(f.tag))) return false;
      }

      if(f.onlyUnread && !t.unread) return false;
      if(f.onlyMine && !t.mine) return false;

      const q = (f.search||"").trim().toLowerCase();
      if(q){
        const hay = [
          t.name, t.user, t.category, t.item, (t.tags||[]).join(" ")
        ].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }

      return true;
    }

    function sortTickets(arr){
      const f = state.filters;
      const copy = [...arr];
      copy.sort((a,b)=>{
        if(f.sortBy==="old") return a.createdAt - b.createdAt;
        return b.createdAt - a.createdAt;
      });
      return copy;
    }

    function renderTickets(){
      const tickets = sortTickets(state.tickets.filter(passesFilters));
      elTicketList.innerHTML = "";

      tickets.forEach(t=>{
        const wrap = document.createElement("div");
        wrap.className = "ticket" + (t.id===state.selectedId ? " active" : "");
        wrap.addEventListener("click", ()=>selectTicket(t.id));

        const [label, cls] = statusBadge(t.status);

        const top = document.createElement("div");
        top.className = "ticket__top";

        const name = document.createElement("div");
        name.className = "ticket__name";
        name.textContent = t.name;

        const meta = document.createElement("div");
        meta.className = "ticket__meta";

        const badge = document.createElement("span");
        badge.className = "badge " + cls;
        badge.textContent = label;

        const small = document.createElement("span");
        small.textContent = t.category;

        meta.appendChild(badge);
        meta.appendChild(small);

        top.appendChild(name);
        top.appendChild(meta);

        const snippet = document.createElement("div");
        snippet.className = "ticket__snippet";
        snippet.textContent = getSnippet(t);

        const tags = document.createElement("div");
        tags.className = "ticket__tags";
        (t.tags||[]).slice(0,3).forEach(tag=>{
          const tg = document.createElement("div");
          tg.className = "tag";
          tg.textContent = normalizeTag(tag);
          tg.addEventListener("click", (e)=>{
            e.stopPropagation();
            state.filters.tag = normalizeTag(tag);
            save();
            renderAll();
          });
          tags.appendChild(tg);
        });

        wrap.appendChild(top);
        wrap.appendChild(snippet);
        if((t.tags||[]).length) wrap.appendChild(tags);

        elTicketList.appendChild(wrap);
      });

      const hasSelected = tickets.some(t=>t.id===state.selectedId);
      if(!hasSelected && tickets.length){
        state.selectedId = tickets[0].id;
        save();
        renderAll();
      }

      if(!tickets.length){
        const empty = document.createElement("div");
        empty.style.padding = "18px";
        empty.className = "muted";
        empty.textContent = "Nenhum ticket encontrado com esses filtros.";
        elTicketList.appendChild(empty);
      }
    }

    function getSnippet(t){
      const msgs = t.messages || [];
      const last = [...msgs].reverse().find(m => m.type !== "sys");
      if(!last) return "Sem mensagens.";
      return (last.type==="me" ? "VocÃª: " : "") + last.text.slice(0,90);
    }

    function renderChat(){
      const t = getSelected();
      elChat.innerHTML = "";

      const sysTop = (t.messages||[]).find(m => m.type==="sys");
      elBanner.textContent = sysTop ? sysTop.text : "Ticket aberto.";

      (t.messages||[]).forEach(m=>{
        if(m.type==="sys"){
          const row = document.createElement("div");
          row.className = "sys";
          const b = document.createElement("div");
          b.className = "sys__bubble";
          b.textContent = m.text;
          row.appendChild(b);
          elChat.appendChild(row);
          return;
        }

        const row = document.createElement("div");
        row.className = "msgRow" + (m.type==="me" ? " me" : "");
        const bubble = document.createElement("div");
        bubble.className = "bubble" + (m.type==="me" ? " me" : "");
        bubble.textContent = m.text;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = formatTime(m.at || t.createdAt);

        bubble.appendChild(meta);
        row.appendChild(bubble);
        elChat.appendChild(row);
      });
    }

    function scrollChatBottom(){
      elChat.scrollTop = elChat.scrollHeight;
    }

    function formatTime(ts){
      try{
        const d = new Date(ts);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }catch{
        return "";
      }
    }

    function renderRightPanel(){
      const t = getSelected();
      const activeTab = document.querySelector(".tab.active")?.dataset?.tab || "info";

      document.getElementById("statSpent").textContent = String(t.spent ?? 13);
      document.getElementById("statOrders").textContent = String(t.orders ?? 1);
      document.getElementById("statItems").textContent = String(t.items ?? 1);

      if(activeTab === "info"){
        elPanelBody.innerHTML = `
          <div class="row"><div class="k">Pedido</div><div class="v">${t.category}</div></div>
          <div class="row"><div class="k">Data</div><div class="v">${new Date(t.createdAt).toLocaleString("pt-BR")}</div></div>
          <div class="row"><div class="k">ID Pedido</div><div class="v">${hashId(t.id)}</div></div>
          <div class="row"><div class="k">Valor Total</div><div class="v" style="color:${t.status==="paid" ? "var(--good)" : "rgba(255,255,255,.9)"}">${t.total}</div></div>
          <div class="row"><div class="k">Nickname Roblox</div><div class="v">${t.nick}</div></div>
          <div class="row"><div class="k">Link da Gamepass</div><div class="v">${t.gamepass && t.gamepass!=="-" ? `<a class="v link" href="${t.gamepass}" target="_blank" rel="noreferrer">${t.gamepass}</a>` : "-"}</div></div>
          <div class="row"><div class="k">Item</div><div class="v">${t.item}</div></div>
          <div class="row"><div class="k">Cliente</div><div class="v">${t.client}${t.clientEmail && t.clientEmail!=="-" ? ` <span class="muted">(${t.clientEmail})</span>` : ""}</div></div>
        `;
      } else if(activeTab === "items"){
        elPanelBody.innerHTML = `
          <div class="row"><div class="k">Item</div><div class="v">${t.item}</div></div>
          <div class="row"><div class="k">Categoria</div><div class="v">${t.category}</div></div>
          <div class="row"><div class="k">Status</div><div class="v">${statusBadge(t.status)[0]}</div></div>
          <div class="row"><div class="k">Quantidade</div><div class="v">1</div></div>
        `;
      } else {
        elPanelBody.innerHTML = `
          <div class="row"><div class="k">AÃ§Ãµes rÃ¡pidas</div><div class="v"></div></div>
          <div class="muted">â€¢ LIBERAR: marca como lido e adiciona evento no chat.</div>
          <div class="muted" style="margin-top:6px">â€¢ RESOLVER: marca como PAGO e adiciona tag ENTREGUE.</div>
          <div class="muted" style="margin-top:6px">â€¢ Clique nas tags para filtrar.</div>
        `;
      }

      elTicketTags.innerHTML = "";
      (t.tags || []).forEach(tag=>{
        const tg = document.createElement("div");
        tg.className = "tag removable";
        tg.textContent = normalizeTag(tag);
        tg.title = "Clique para remover";
        tg.addEventListener("click", ()=> removeTag(tag));
        elTicketTags.appendChild(tg);
      });

      if(!(t.tags||[]).length){
        const none = document.createElement("div");
        none.className = "muted";
        none.textContent = "Sem tags ainda.";
        elTicketTags.appendChild(none);
      }
    }

    function hashId(id){
      const s = "4c6b26f3a71e" + id.replace(/\D/g,"");
      return s.slice(0,12) + "-4...";
    }

    function renderAll(){
      renderStatusPills();
      renderTagCloud();
      renderTickets();
      renderChat();
      renderRightPanel();
    }

    renderAll();
    setTimeout(scrollChatBottom, 60);
  </script>
</body>
</html>
