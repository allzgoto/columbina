<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Panel ‚Äî Conversas</title>
  <style>
    :root{
      --bg:#0a0b0f;
      --stroke:rgba(255,255,255,.07);
      --text:#e9e9ee;
      --muted:#a2a2b3;
      --accent:#b300ff;
      --accent2:#ff00d4;
      --good:#33d17a;
      --warn:#f2b01e;
      --bad:#ff4d4d;
      --shadow:0 18px 60px rgba(0,0,0,.65);
      --radius:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 25% 10%, rgba(179,0,255,.12), transparent 60%),
        radial-gradient(900px 700px at 70% 0%, rgba(255,0,212,.08), transparent 55%),
        linear-gradient(180deg, var(--bg), #07080b);
      overflow:hidden;
    }
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 340px 1fr 360px;
      gap:14px;
      padding:14px;
    }

    /* LEFT */
    .left{
      background: linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .left__header{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--stroke);
      position:relative;
      z-index:5;
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:0}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--good);
      box-shadow:0 0 0 6px rgba(51,209,122,.12);
      flex:0 0 auto;
    }
    .brand__title{font-weight:900; letter-spacing:.2px}
    .brand__sub{font-size:12px;color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .left__actions{display:flex; gap:8px; flex:0 0 auto}

    .iconbtn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition:transform .08s ease, background .15s ease;
      position:relative;
      z-index:6;
    }
    .iconbtn svg{pointer-events:none}
    .iconbtn:hover{background:rgba(255,255,255,.06)}
    .iconbtn:active{transform:translateY(1px)}

    /* Queue tabs */
    .queues{
      padding:10px 12px 0;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .qtab{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .qtab.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
      box-shadow:0 0 0 6px rgba(179,0,255,.08);
    }
    .qbadge{
      font-size:11px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(179,0,255,.22);
      background:rgba(179,0,255,.10);
      color:rgba(255,255,255,.92);
    }

    .search{padding:10px 14px}
    .search input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .search input::placeholder{color:rgba(255,255,255,.35)}

    .list{
      padding:6px;
      overflow:auto;
      flex:1;
    }
    .ticket{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid transparent;
      background:rgba(255,255,255,.02);
      margin:6px;
      cursor:pointer;
      display:grid;
      gap:6px;
      transition:background .12s ease, border-color .12s ease;
    }
    .ticket:hover{background:rgba(255,255,255,.045)}
    .ticket.active{
      border-color:rgba(179,0,255,.35);
      background: linear-gradient(180deg, rgba(179,0,255,.12), rgba(255,0,212,.06));
    }
    .ticket__top{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .ticket__name{font-weight:900}
    .ticket__meta{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.09);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{color:var(--good); border-color:rgba(51,209,122,.25); background:rgba(51,209,122,.08)}
    .badge.warn{color:var(--warn); border-color:rgba(242,176,30,.25); background:rgba(242,176,30,.08)}
    .badge.bad{color:var(--bad); border-color:rgba(255,77,77,.25); background:rgba(255,77,77,.08)}
    .ticket__snippet{font-size:13px; color:rgba(255,255,255,.78); line-height:1.25}
    .ticket__tags{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(179,0,255,.22);
      background:rgba(179,0,255,.08);
      color:rgba(255,255,255,.9);
      cursor:pointer;
      user-select:none;
    }
    .unreadDot{
      width:8px;height:8px;border-radius:50%;
      background:rgba(255,0,212,.9);
      box-shadow:0 0 0 6px rgba(255,0,212,.10);
      display:inline-block;
    }

    /* Filters drawer */
    .filters{
      position:absolute;
      top:0; right:-320px;
      width:300px;
      height:100%;
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(8,9,12,.98));
      border-left:1px solid var(--stroke);
      transition:right .22s ease;
      box-shadow:-18px 0 60px rgba(0,0,0,.55);
      padding:14px 12px;
      overflow:auto;
      z-index:40;
    }
    .filters.open{right:0}
    .filters__header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid var(--stroke);
      position:sticky;
      top:0;
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(12,14,20,.92));
      z-index:2;
      margin:-14px -12px 10px;
      padding:14px 12px 10px;
    }
    .filters__title{font-weight:900}
    .filters__section{padding:12px 0; border-bottom:1px solid rgba(255,255,255,.05)}
    .filters__label{font-size:12px; color:var(--muted); margin-bottom:10px; text-transform:uppercase; letter-spacing:.8px}
    .pillRow{display:flex; flex-wrap:wrap; gap:8px}
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
      box-shadow:0 0 0 6px rgba(179,0,255,.08);
    }
    .check{display:flex; align-items:center; gap:10px; color:rgba(255,255,255,.85); font-size:13px; margin:8px 0}
    .check input{accent-color: var(--accent)}
    .select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .tagCloud{display:flex; flex-wrap:wrap; gap:8px}
    .tagCloud .tag{
      border-color:rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.85);
    }
    .tagCloud .tag.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
    }

    /* CENTER */
    .center{
      background: linear-gradient(180deg, rgba(15,17,24,.78), rgba(8,9,12,.78));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
      position:relative;
    }
    .center__top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      position:relative;
      z-index:6;
    }
    .banner{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
      min-width:0;
    }
    .banner span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .center__topRight{display:flex; gap:10px; align-items:center}
    .btn{
      height:38px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      letter-spacing:.4px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      gap:8px;
      position:relative;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:active{transform:translateY(1px)}
    .btn.warn{
      border-color:rgba(242,176,30,.25);
      background:rgba(242,176,30,.08);
    }
    .btn.ghost{
      border-color:rgba(179,0,255,.25);
      background:rgba(179,0,255,.10);
    }
    .btn.small{height:34px; border-radius:12px; padding:0 12px; font-weight:900}
    .dotSmall{
      width:7px;height:7px;border-radius:50%;
      background:rgba(179,0,255,.95);
      box-shadow:0 0 0 6px rgba(179,0,255,.12);
    }

    /* Mobile-only back button inside center top */
    .mBack{
      display:none;
      height:38px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:900;
      gap:8px;
      align-items:center;
    }
    .mBack:hover{background:rgba(255,255,255,.06)}
    .mBack svg{pointer-events:none}

    /* Notification bell + panel */
    .bell{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      cursor:pointer;
      position:relative;
    }
    .bell svg{pointer-events:none}
    .bell:hover{background:rgba(255,255,255,.06)}
    .bellBadge{
      position:absolute;
      top:6px; right:6px;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
      font-weight:900;
      color:#fff;
      background:rgba(255,0,212,.95);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }

    .notiPanel{
      position:absolute;
      right:14px;
      top:60px;
      width:min(420px, calc(100vw - 28px));
      max-height:70vh;
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(179,0,255,.25);
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(8,9,12,.98));
      box-shadow:0 18px 70px rgba(0,0,0,.72);
      display:none;
      z-index:50;
    }
    .notiPanel.open{display:block}
    .notiHead{
      position:sticky; top:0;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(12,14,20,.98), rgba(12,14,20,.92));
    }
    .notiTitle{font-weight:900}
    .notiActions{display:flex; gap:8px}
    .miniBtn{
      height:34px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.9);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .miniBtn:hover{background:rgba(255,255,255,.06)}
    .notiItem{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      cursor:pointer;
    }
    .notiItem:hover{background:rgba(255,255,255,.03)}
    .notiDot{
      width:10px;height:10px;border-radius:50%;
      background:rgba(255,0,212,.95);
      box-shadow:0 0 0 6px rgba(255,0,212,.10);
      flex:0 0 auto;
      margin-top:4px;
    }
    .notiText b{font-weight:900}
    .notiMeta{margin-top:3px; font-size:12px; color:rgba(255,255,255,.65)}
    .notiEmpty{padding:14px; color:rgba(255,255,255,.55); font-size:13px}

    .chatWrap{flex:1; display:flex; flex-direction:column; min-height:0}
.chat{
  padding:14px 16px 8px;
      overflow:auto;
      flex:1;
    }
    .sys{
      width:100%;
      display:flex;
      justify-content:center;
      margin:10px 0;
    }
    .sys .sys__bubble{
      padding:10px 12px;
      max-width:900px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      color:rgba(255,255,255,.7);
      font-size:13px;
    }
  .msgRow{
  display:flex;
  margin:6px 0;
}
    .msgRow.me{justify-content:flex-end}
    .bubble{
max-width:min(520px, 70%);
padding:12px 14px;
border-radius:16px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.88);
      line-height:1.25;
      box-shadow:0 10px 35px rgba(0,0,0,.35);
      position:relative;
      font-size:14px;
      white-space:pre-wrap;
    }
    .bubble.me{
      background:linear-gradient(180deg, rgba(179,0,255,.92), rgba(179,0,255,.70));
      border-color:rgba(255,255,255,.12);
      color:#fff;
    }
    .bubble .meta{
      margin-top:8px;
      font-size:11px;
      color:rgba(255,255,255,.75);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }
    .delBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.15);
      color:rgba(255,255,255,.9);
      border-radius:10px;
      padding:3px 8px;
      cursor:pointer;
      font-weight:900;
      font-size:11px;
      display:none;
    }
    .msgRow.me .bubble:hover .delBtn{display:inline-flex}
    .composer{
      padding:12px;
      border-top:1px solid var(--stroke);
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(0,0,0,.12);
    }
    .composer input{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .send{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(179,0,255,.35);
      background:rgba(179,0,255,.18);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition:transform .08s ease, background .15s ease;
    }
    .send:hover{background:rgba(179,0,255,.25)}
    .send:active{transform:translateY(1px)}

    /* RIGHT */
    .right{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .stat{
      background:linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow:var(--shadow);
    }
    .stat__label{
      font-size:11px;
      letter-spacing:1px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .stat__value{
      margin-top:8px;
      font-size:18px;
      font-weight:900;
    }

    .panel{
      background:linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel__tabs{
      display:flex;
      border-bottom:1px solid var(--stroke);
      gap:8px;
      padding:10px;
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:900;
    }
    .tab.active{
      border-color:rgba(179,0,255,.35);
      background:rgba(179,0,255,.12);
    }
    .panel__body{padding:14px}
    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .row:last-child{border-bottom:none}
    .k{color:var(--muted); font-size:12px}
    .v{font-weight:900}
    .v.link{
      color:rgba(179,0,255,.95);
      text-decoration:none;
      font-weight:900;
      word-break:break-all;
    }
    .v.link:hover{text-decoration:underline}
    .muted{color:rgba(255,255,255,.45); font-size:12px}

    .tagRow{display:flex; flex-wrap:wrap; gap:8px}
    .tagRow .tag{border-color:rgba(179,0,255,.25); background:rgba(179,0,255,.10)}
    .tagRow .tag.removable{position:relative; padding-right:26px}
    .tagRow .tag.removable::after{
      content:"√ó";
      position:absolute;
      right:9px; top:3px;
      opacity:.85;
      font-weight:900;
    }
    .tagAdd{display:flex; gap:8px; margin-top:12px}
    .tagAdd input{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }

    /* Toast notifications (PC) */
    .toasts{
      position:fixed;
      right:14px;
      top:14px;
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      width:min(420px, calc(100vw - 28px));
      border-radius:16px;
      border:1px solid rgba(179,0,255,.25);
      background:linear-gradient(180deg, rgba(179,0,255,.20), rgba(15,17,24,.92));
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: toastIn .18s ease-out;
    }
    @keyframes toastIn{
      from{transform:translateY(-8px); opacity:.0}
      to{transform:translateY(0); opacity:1}
    }
    .toast b{font-weight:900}
    .toast .tmeta{font-size:12px; color:rgba(255,255,255,.7); margin-top:4px}
    .toast .ticon{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      flex:0 0 auto;
    }

    /* Scrollbars */
    .list::-webkit-scrollbar, .chat::-webkit-scrollbar, .filters::-webkit-scrollbar, .notiPanel::-webkit-scrollbar{width:10px}
    .list::-webkit-scrollbar-thumb, .chat::-webkit-scrollbar-thumb, .filters::-webkit-scrollbar-thumb, .notiPanel::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.08);
      border:2px solid rgba(0,0,0,0);
      background-clip:padding-box;
      border-radius:999px;
    }
    .list::-webkit-scrollbar-track, .chat::-webkit-scrollbar-track, .filters::-webkit-scrollbar-track, .notiPanel::-webkit-scrollbar-track{
      background:transparent;
    }

    /* MOBILE MODE (3 telas) */
    .mNav{
      display:none;
      position:fixed;
      left:10px;
      right:10px;
      bottom:10px;
      z-index:60;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(15,17,24,.92), rgba(10,11,15,.92));
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      padding:8px;
      gap:8px;
      grid-template-columns: repeat(3, 1fr);
    }
    .mNav button{
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.9);
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .mNav button.active{
      border-color:rgba(179,0,255,.45);
      background:rgba(179,0,255,.13);
      box-shadow:0 0 0 6px rgba(179,0,255,.08);
    }
    .mNav button svg{pointer-events:none}
    .mNavBadge{
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:900;
      background:rgba(255,0,212,.95);
      border:1px solid rgba(255,255,255,.16);
    }

    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns: 340px 1fr; grid-template-rows:auto auto; height:auto}
      .right{grid-column: 1 / -1}
    }

    @media (max-width: 820px){
      body{overflow:hidden}
      .app{
        height:100%;
        grid-template-columns: 1fr;
        padding:10px;
        padding-bottom:78px;
        gap:10px;
      }

      .left,.center,.right{display:none; height:calc(100vh - 88px)}
      body[data-view="list"] .left{display:flex}
      body[data-view="chat"] .center{display:flex}
      body[data-view="details"] .right{display:flex}

      .mNav{display:grid}

      .filters{
        position:fixed;
        top:10px;
        bottom:10px;
        height:auto;
        right:-100vw;
        width:min(92vw, 360px);
        border-radius:16px;
        border:1px solid var(--stroke);
      }
      .filters.open{right:10px}

      .notiPanel{
        right:10px;
        top:70px;
        width:min(92vw, 420px);
      }

      .mBack{display:inline-flex}
    }
  </style>
</head>

<body data-view="list">
  <div class="toasts" id="toasts"></div>

  <!-- Mobile bottom nav -->
  <div class="mNav" id="mNav">
    <button id="mNavList" class="active" type="button" title="Conversas">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Conversas
    </button>
    <button id="mNavChat" type="button" title="Chat">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M21 15a4 4 0 01-4 4H8l-5 3V7a4 4 0 014-4h10a4 4 0 014 4v8z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
      </svg>
      Chat
    </button>
    <button id="mNavDetails" type="button" title="Detalhes">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M10 3h4M12 7v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Detalhes
      <span class="mNavBadge" id="mNavBadge" style="display:none">0</span>
    </button>
  </div>

  <div class="app">
    <!-- LEFT -->
    <aside class="left" id="paneLeft">
      <div class="left__header">
        <div class="brand">
          <div class="dot"></div>
          <div style="min-width:0">
            <div class="brand__title">Conversas</div>
            <div class="brand__sub">Bem-vindo(a), <b id="agentName">Allz</b> ‚Ä¢ <span id="liveLabel">ao vivo</span></div>
          </div>
        </div>
        <div class="left__actions">
          <button class="iconbtn" id="btnFilters" title="Filtros">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="queues" id="queueTabs"></div>

      <div class="search">
        <input id="searchInput" type="text" placeholder="Pesquisar..." />
      </div>

      <div class="list" id="ticketList"></div>

      <!-- FILTERS DRAWER -->
      <div class="filters" id="filters">
        <div class="filters__header">
          <div class="filters__title">Filtros</div>
          <button class="iconbtn" id="btnCloseFilters" title="Fechar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <div class="filters__section">
          <div class="filters__label">Status pagamento</div>
          <div class="pillRow" id="statusPills"></div>
        </div>

        <div class="filters__section">
          <label class="check">
            <input type="checkbox" id="onlyUnread" />
            <span>Apenas n√£o lidos</span>
          </label>
          <label class="check">
            <input type="checkbox" id="onlyMine" />
            <span>Meus tickets</span>
          </label>
          <label class="check">
            <input type="checkbox" id="soundOn" />
            <span>Som de notifica√ß√£o</span>
          </label>
          <label class="check">
            <input type="checkbox" id="demoSim" />
            <span>Simular mensagens (DEMO)</span>
          </label>
        </div>

        <div class="filters__section">
          <div class="filters__label">Ordenar por</div>
          <select id="sortBy" class="select">
            <option value="recent">Mais recentes</option>
            <option value="old">Mais antigos</option>
          </select>
        </div>

        <div class="filters__section">
          <div class="filters__label">Filtrar por Tag</div>
          <div class="tagCloud" id="tagCloud"></div>
          <div class="muted" style="margin-top:8px">
            *Tags aparecem conforme voc√™ adiciona nos tickets.
          </div>
        </div>

        <div class="filters__section" style="border-bottom:none">
          <div class="filters__label">Atualiza√ß√£o</div>
          <div class="muted">Mobile agora vira 3 telas (Conversas/Chat/Detalhes).</div>
        </div>
      </div>
    </aside>
        <!-- CENTER -->
    <main class="center" id="paneCenter">
      <div class="center__top">
        <!-- mobile back -->
        <button class="mBack" id="btnMobileBack" type="button" title="Voltar para conversas">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Voltar
        </button>

        <div class="banner">
          <span>üéâ</span>
          <span id="bannerText">Pagamento confirmado! Seu pedido est√° sendo processado...</span>
        </div>

        <div class="center__topRight">
          <button class="bell" id="btnBell" title="Notifica√ß√µes">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              <path d="M13.73 21a2 2 0 01-3.46 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
            <span class="bellBadge" id="bellBadge" style="display:none">0</span>
          </button>

          <button class="btn ghost" id="btnLiberar"><span class="dotSmall"></span>LIBERAR</button>
          <button class="btn warn" id="btnResolver">RESOLVER</button>
        </div>
      </div>

      <div class="notiPanel" id="notiPanel" aria-hidden="true">
        <div class="notiHead">
          <div class="notiTitle">Notifica√ß√µes</div>
          <div class="notiActions">
            <button class="miniBtn" id="btnMarkAllRead">Ler tudo</button>
            <button class="miniBtn" id="btnClearNoti">Limpar</button>
          </div>
        </div>
        <div id="notiList"></div>
      </div>

      <div class="chatWrap">
        <div class="chat" id="chat"></div>

        <div class="composer">
          <input id="msgInput" type="text" placeholder="Digite sua mensagem..." />
          <button class="send" id="btnSend" title="Enviar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M22 2L15 22l-4-9-9-4L22 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="right" id="paneRight">
      <div class="stats">
        <div class="stat">
          <div class="stat__label">GASTOS</div>
          <div class="stat__value">R$ <span id="statSpent">13</span></div>
        </div>
        <div class="stat">
          <div class="stat__label">PEDIDOS</div>
          <div class="stat__value" id="statOrders">1</div>
        </div>
        <div class="stat">
          <div class="stat__label">ITENS</div>
          <div class="stat__value" id="statItems">1</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel__tabs">
          <button class="tab active" data-tab="info">Info</button>
          <button class="tab" data-tab="items">Items</button>
          <button class="tab" data-tab="actions">A√ß√µes</button>
        </div>
        <div class="panel__body" id="panelBody"></div>
      </div>

      <div class="panel">
        <div class="panel__header"><div class="panel__title">Tags do Ticket</div></div>
        <div class="panel__body">
          <div class="tagRow" id="ticketTags"></div>

          <div class="tagAdd">
            <input id="tagInput" type="text" placeholder="Adicionar tag (ex: MM2, ENTREGUE, BUG...)" />
            <button class="btn small" id="btnAddTag">Adicionar</button>
          </div>

          <div class="muted" style="margin-top:10px">
            Dica: clique numa tag acima para remover.
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const LS_KEY = "staff_panel_v3_2_mobile";
    const AGENT = "Allz";

    const AUTO_REMOVE_DELIVERED_MS = 60 * 60 * 1000; // 1 hour
    const POLL_MS = 2500;
    const SIMULATE_REPLY_PROB = 0.22;

    const QUEUES = [
      { id:"all", label:"TODAS" },
      { id:"DTI", label:"DTI" },
      { id:"PEDIDOS_NOVOS", label:"PEDIDOS NOVOS" },
      { id:"SEM_GAMEPASS", label:"SEM GAMEPASS" },
      { id:"BLOXFRUITS", label:"BLOXFRUITS" },
      { id:"MM2", label:"MM2" },
      { id:"FILA_DE_ENTREGA", label:"FILA DE ENTREGA" },
    ];

    const STATUS = [
      { id:"all", label:"Todos" },
      { id:"paid", label:"Pagos" },
      { id:"pending", label:"Pendentes" },
      { id:"refunded", label:"Reembolsados" },
      { id:"canceled", label:"Cancelados" },
    ];

    function isMobile(){ return window.matchMedia("(max-width: 820px)").matches; }

    // Mobile view state
    function setView(v){
      document.body.setAttribute("data-view", v);
      // nav active
      mNavList.classList.toggle("active", v==="list");
      mNavChat.classList.toggle("active", v==="chat");
      mNavDetails.classList.toggle("active", v==="details");
    }
    function getView(){ return document.body.getAttribute("data-view") || "list"; }

    function nowMinusMinutes(m){ return Date.now() - (m*60*1000); }
    function rid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

    function normalizeTag(tag){
      return String(tag).trim().toUpperCase().replace(/\s+/g,"_");
    }
    function uniqueTags(arr){
      const set = new Set(arr.map(normalizeTag));
      return Array.from(set);
    }

    function seedTicketsBase(){
      // Base + mais tickets artificiais (>= 15) pra testar
      const base = [
        {
          id:"t1",
          queue:"PEDIDOS_NOVOS",
          name:"Kamila",
          user:"Wzkamila",
          createdAt: nowMinusMinutes(35),
          unread:true,
          mine:true,
          status:"pending",
          category:"ROBUX_GAMEPASS",
          total:"R$ 12,60",
          nick:"revoltadinha13",
          gamepass:"https://www.roblox.com/game-pass/1573179189",
          item:"300 Robux (via Gamepass)",
          client:"Esmeralda",
          clientEmail:"cm5592521@gmail.com",
          spent:13, orders:1, items:1,
          tags:["GAMEPASS","SEM_GAMEPASS"],
          deliveredAt:null,
          messages: [
            { id: rid(), type:"sys", text:"üéâ Pagamento confirmado! Seu pedido est√° sendo processado. Nossa equipe entrar√° em contato em breve para realizar a entrega." },
            { id: rid(), type:"sys", text:"Allz assumiu este atendimento." },
            { id: rid(), type:"me", text:"Ol√°! Muito obrigado pela sua compra, caso tenha alguma d√∫vida, pode me informar aqui ou l√° no discord, abrindo suporte. Entregaremos o mais r√°pido poss√≠vel, ainda hoje! üíú", ts: nowMinusMinutes(34) },
            { id: rid(), type:"me", text:"Verifiquei que ainda n√£o enviou sua gamepass, precisa de ajuda com isso? Caso ela apenas n√£o tenha sido encontrada, v√° em \"minhas compras\" e selecione a compra que est√° tendo problemas, ap√≥s isso √© s√≥ clicar em \"inserir link manualmente\" e colocar o link de sua gamepass! Lembre-se de desativar os pre√ßos regionais.", ts: nowMinusMinutes(33) },
          ],
        },
      ];

      const names = [
        ["Lipe nuts","lipezzk077","MM2","paid","ENTREGUE"],
        ["DUDAXLSANTOS","dudaxlsantos","SEM_GAMEPASS","pending","SEM_GAMEPASS"],
        ["w1s.","southnak","DTI","pending","MM2"],
        ["b.ferrazxl","brunoteixeiraferrarazferraz@gmail.com","FILA_DE_ENTREGA","refunded","REEMBOLSO"],
        ["ThayS","myleswr0","DTI","pending","PEDIDOS_NOVOS"],
        ["Nina","ninazyn","PEDIDOS_NOVOS","pending","GAMEPASS"],
        ["Renan","renanx","SEM_GAMEPASS","pending","SEM_GAMEPASS"],
        ["Brenda","brendinha","FILA_DE_ENTREGA","pending","MM2"],
        ["Bryan","bryanz","BLOXFRUITS","paid","ENTREGUE"],
        ["Laura","lauraz","PEDIDOS_NOVOS","pending","GAMEPASS"],
        ["Leticia","letz","DTI","pending","MM2"],
        ["Paulo","pauloz","MM2","pending","MM2"],
        ["Miguel","migz","PEDIDOS_NOVOS","pending","GAMEPASS"],
        ["Yasmim","yasmimz","BLOXFRUITS","pending","BLOXFRUITS"],
        ["Riquelmy","rikz","FILA_DE_ENTREGA","pending","FILA_DE_ENTREGA"],
        ["Liz","lizz","SEM_GAMEPASS","canceled","CANCELADO"],
      ];

      const extra = names.map((n,idx)=>{
        const id = "t" + (idx+2);
        const created = nowMinusMinutes(10 + idx*3);
        const queue = n[2];
        const status = n[3];
        const mainTag = n[4];
        const isDelivered = mainTag === "ENTREGUE";
        return {
          id,
          queue,
          name:n[0],
          user:n[1],
          createdAt: created,
          unread: Math.random() < 0.45,
          mine: Math.random() < 0.55,
          status,
          category:"ROBUX_GAMEPASS",
          total:"R$ 12,60",
          nick:"user_" + (idx+10),
          gamepass:"https://www.roblox.com/game-pass/" + (1573179000 + idx),
          item: (queue==="BLOXFRUITS" ? "BloxFruits (item)" : "Robux (via Gamepass)"),
          client:n[0],
          clientEmail:(n[0].toLowerCase().replace(/\s+/g,"") + "@gmail.com"),
          spent:13, orders:1, items:1,
          tags: uniqueTags([mainTag, queue]),
          deliveredAt: isDelivered ? (Date.now() - (20*60*1000)) : null,
          messages:[
            { id: rid(), type:"sys", text:"Pagamento confirmado! Seu pedido est√° sendo processado." },
            { id: rid(), type:"sys", text:`${AGENT} assumiu este atendimento.` },
            { id: rid(), type:"client", text:(Math.random()<.5?"Oi, quando entrega meu item?":"Opa, onde envio o link da gamepass?"), ts: created+60*1000 },
          ]
        };
      });

      // Ajuste r√°pido pra ‚ÄúLipe nuts‚Äù ficar ENTREGUE/ pago (igual print)
      extra[0].tags = uniqueTags(["ENTREGUE","MM2"]);
      extra[0].status = "paid";
      extra[0].deliveredAt = Date.now() - (30*60*1000);
      extra[0].unread = false;

      return base.concat(extra);
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function formatTime(ts){
      const d = new Date(ts || Date.now());
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    // UI refs
    const ticketList = document.getElementById("ticketList");
    const chatEl = document.getElementById("chat");
    const panelBody = document.getElementById("panelBody");
    const ticketTagsEl = document.getElementById("ticketTags");

    const tagCloud = document.getElementById("tagCloud");
    const statusPills = document.getElementById("statusPills");
    const queueTabs = document.getElementById("queueTabs");

    const searchInput = document.getElementById("searchInput");
    const msgInput = document.getElementById("msgInput");
    const btnSend = document.getElementById("btnSend");

    const btnFilters = document.getElementById("btnFilters");
    const btnCloseFilters = document.getElementById("btnCloseFilters");
    const filters = document.getElementById("filters");

    const onlyUnread = document.getElementById("onlyUnread");
    const onlyMine = document.getElementById("onlyMine");
    const soundOn = document.getElementById("soundOn");
    const demoSim = document.getElementById("demoSim");
    const sortBy = document.getElementById("sortBy");

    const btnLiberar = document.getElementById("btnLiberar");
    const btnResolver = document.getElementById("btnResolver");

    const btnAddTag = document.getElementById("btnAddTag");
    const tagInput = document.getElementById("tagInput");

    const toastsEl = document.getElementById("toasts");

    // notifications
    const btnBell = document.getElementById("btnBell");
    const notiPanel = document.getElementById("notiPanel");
    const notiList = document.getElementById("notiList");
    const bellBadge = document.getElementById("bellBadge");
    const btnMarkAllRead = document.getElementById("btnMarkAllRead");
    const btnClearNoti = document.getElementById("btnClearNoti");

    // mobile
    const mNavList = document.getElementById("mNavList");
    const mNavChat = document.getElementById("mNavChat");
    const mNavDetails = document.getElementById("mNavDetails");
    const mNavBadge = document.getElementById("mNavBadge");
    const btnMobileBack = document.getElementById("btnMobileBack");

    let state = loadState() || {
      agent: AGENT,
      tickets: seedTicketsBase(),
      activeTicketId: "t1",
      filters:{
        queue:"all",
        status:"all",
        onlyUnread:false,
        onlyMine:false,
        tag:null,
        search:"",
        sort:"recent",
        sound:true,
        demo:true,
      },
      panelTab:"info",
      notifications: [],
      notiReadIds: [],
    };
    saveState();
        function toast(title, msg){
      const el = document.createElement("div");
      el.className = "toast";
      el.innerHTML = `
        <div class="ticon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3 3-7z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <b>${title}</b>
          <div class="tmeta">${msg}</div>
        </div>
      `;
      toastsEl.appendChild(el);
      setTimeout(()=> el.remove(), 2800);
    }

    // ====== NOTIFICATIONS (store + panel) ======
    function addNotification({ticketId, title, text}){
      const n = {
        id: rid(),
        ticketId,
        title,
        text,
        ts: Date.now(),
        read: false
      };
      state.notifications.unshift(n);
      saveState();
      renderNotifications();
    }

    function markAllNotificationsRead(){
      state.notifications.forEach(n => n.read = true);
      saveState();
      renderNotifications();
    }

    function clearNotifications(){
      state.notifications = [];
      saveState();
      renderNotifications();
    }

    function unreadNotiCount(){
      return state.notifications.filter(n => !n.read).length;
    }

    function renderNotifications(){
      const unread = unreadNotiCount();

      if(unread > 0){
        bellBadge.style.display = "";
        bellBadge.textContent = String(unread);
        mNavBadge.style.display = "";
        mNavBadge.textContent = String(unread);
      }else{
        bellBadge.style.display = "none";
        mNavBadge.style.display = "none";
      }

      if(state.notifications.length === 0){
        notiList.innerHTML = `<div class="notiEmpty">Sem notifica√ß√µes.</div>`;
        return;
      }

      notiList.innerHTML = state.notifications.map(n => `
        <div class="notiItem" data-nid="${n.id}">
          ${n.read ? `<div style="width:10px;height:10px;opacity:.25"></div>` : `<div class="notiDot"></div>`}
          <div class="notiText">
            <b>${escapeHtml(n.title)}</b><br/>
            <span>${escapeHtml(n.text)}</span>
            <div class="notiMeta">${new Date(n.ts).toLocaleString()}</div>
          </div>
        </div>
      `).join("");

      // click -> mark read + open ticket
      notiList.querySelectorAll(".notiItem").forEach(item=>{
        item.addEventListener("click", ()=>{
          const nid = item.getAttribute("data-nid");
          const n = state.notifications.find(x => x.id === nid);
          if(!n) return;
          n.read = true;
          state.activeTicketId = n.ticketId;
          saveState();
          renderAll();

          // no mobile: vai pro chat
          if(isMobile()) setView("chat");
        });
      });
    }

    // ====== HTML safety ======
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== FILTER HELPERS ======
    function statusBadgeClass(status){
      if(status === "paid") return "good";
      if(status === "pending") return "warn";
      if(status === "refunded") return "good";
      if(status === "canceled") return "bad";
      return "";
    }
    function statusLabel(status){
      const m = {
        paid:"PAGO",
        pending:"PENDENTE",
        refunded:"REEMBOLSADO",
        canceled:"CANCELADO"
      };
      return m[status] || String(status).toUpperCase();
    }

    function queueLabel(q){
      const found = QUEUES.find(x=>x.id===q);
      return found ? found.label : q;
    }

    function ticketMatches(t){
      const f = state.filters;

      if(f.queue !== "all" && t.queue !== f.queue) return false;
      if(f.status !== "all" && t.status !== f.status) return false;
      if(f.onlyUnread && !t.unread) return false;
      if(f.onlyMine && !t.mine) return false;

      if(f.tag){
        const tag = normalizeTag(f.tag);
        const tags = (t.tags||[]).map(normalizeTag);
        if(!tags.includes(tag)) return false;
      }

      const s = (f.search||"").trim().toLowerCase();
      if(s){
        const hay = `${t.name} ${t.user} ${(t.tags||[]).join(" ")} ${t.queue} ${t.status}`.toLowerCase();
        if(!hay.includes(s)) return false;
      }

      return true;
    }

    function getVisibleTickets(){
      const f = state.filters;
      let arr = state.tickets.slice();

      // auto remove delivered after 1 hour
      const now = Date.now();
      arr = arr.filter(t=>{
        if(!t.deliveredAt) return true;
        return (now - t.deliveredAt) < AUTO_REMOVE_DELIVERED_MS;
      });

      // apply filters
      arr = arr.filter(ticketMatches);

      // sort
      if(f.sort === "old"){
        arr.sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
      }else{
        arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      }
      return arr;
    }

    function allTagsInData(){
      const tags = [];
      state.tickets.forEach(t=>{
        (t.tags||[]).forEach(x=>tags.push(normalizeTag(x)));
      });
      // remove duplicates + keep order-ish
      return Array.from(new Set(tags)).sort((a,b)=> a.localeCompare(b));
    }

    // ====== RENDER LEFT (queues + list) ======
    function renderQueueTabs(){
      // counts by queue respecting status/search etc? aqui √© count bruto por queue (mas com outros filtros aplicados exceto queue)
      const f = state.filters;
      const baseFilter = (t)=>{
        // same as ticketMatches but ignoring queue constraint
        const oldQueue = f.queue;
        const tmp = {...f, queue:"all"};
        const prev = state.filters;
        state.filters = tmp;
        const ok = ticketMatches(t);
        state.filters = prev;
        // restore f
        state.filters.queue = oldQueue;
        return ok;
      };

      queueTabs.innerHTML = QUEUES.map(q=>{
        const count = state.tickets.filter(t=> (q.id==="all" ? baseFilter(t) : (baseFilter(t) && t.queue===q.id))).length;
        const active = (state.filters.queue===q.id);
        return `
          <div class="qtab ${active?"active":""}" data-q="${q.id}">
            ${q.label}
            <span class="qbadge">${count}</span>
          </div>
        `;
      }).join("");

      queueTabs.querySelectorAll(".qtab").forEach(el=>{
        el.addEventListener("click", ()=>{
          state.filters.queue = el.getAttribute("data-q");
          saveState();
          renderAll();
        });
      });
    }

    function renderStatusPills(){
      statusPills.innerHTML = STATUS.map(s=>{
        const active = state.filters.status===s.id;
        return `<div class="pill ${active?"active":""}" data-status="${s.id}">${s.label}</div>`;
      }).join("");

      statusPills.querySelectorAll(".pill").forEach(p=>{
        p.addEventListener("click", ()=>{
          state.filters.status = p.getAttribute("data-status");
          saveState();
          renderAll();
        });
      });
    }

    function renderTagCloud(){
      const tags = allTagsInData();
      const active = state.filters.tag ? normalizeTag(state.filters.tag) : null;

      const pills = [`<div class="tag ${!active?"active":""}" data-tag="">Todas</div>`]
        .concat(tags.map(t=> `<div class="tag ${active===t?"active":""}" data-tag="${t}">${t}</div>`));

      tagCloud.innerHTML = pills.join("");

      tagCloud.querySelectorAll(".tag").forEach(t=>{
        t.addEventListener("click", ()=>{
          const tg = t.getAttribute("data-tag");
          state.filters.tag = tg ? tg : null;
          saveState();
          renderAll();
        });
      });
    }

    function renderTicketList(){
      const visible = getVisibleTickets();
      if(!visible.find(t=>t.id===state.activeTicketId) && visible.length){
        state.activeTicketId = visible[0].id;
      }

      ticketList.innerHTML = visible.map(t=>{
        const active = t.id===state.activeTicketId;
        const tags = (t.tags||[]).slice(0,4).map(x=> `<span class="tag">${escapeHtml(normalizeTag(x))}</span>`).join("");
        const unread = t.unread ? `<span class="unreadDot" title="N√£o lido"></span>` : ``;
        const queue = `<span class="badge">${escapeHtml(queueLabel(t.queue).replaceAll(" ","_"))}</span>`;
        const st = `<span class="badge ${statusBadgeClass(t.status)}">${escapeHtml(statusLabel(t.status))}</span>`;
        const snippet = lastSnippet(t);

        return `
          <div class="ticket ${active?"active":""}" data-id="${t.id}">
            <div class="ticket__top">
              <div class="ticket__name">${escapeHtml(t.name)}</div>
              <div class="ticket__meta">
                ${unread}
                ${st}
                ${queue}
              </div>
            </div>
            <div class="ticket__snippet">${escapeHtml(snippet)}</div>
            <div class="ticket__tags">${tags}</div>
          </div>
        `;
      }).join("");

      ticketList.querySelectorAll(".ticket").forEach(card=>{
        card.addEventListener("click", ()=>{
          state.activeTicketId = card.getAttribute("data-id");
          // ao abrir ticket, marca como lido (sem resetar scroll: s√≥ re-render local)
          const t = state.tickets.find(x=>x.id===state.activeTicketId);
          if(t) t.unread = false;

          saveState();
          renderAll();

          // mobile: abre chat
          if(isMobile()) setView("chat");
        });
      });
    }

    function lastSnippet(t){
      const msgs = t.messages || [];
      for(let i=msgs.length-1;i>=0;i--){
        const m = msgs[i];
        if(m.type==="me") return "Voc√™: " + m.text.slice(0,62);
        if(m.type==="client") return m.text.slice(0,62);
      }
      return "‚Äî";
    }

    // ====== RENDER CENTER (chat) ======
    function renderChat(){
      const t = state.tickets.find(x=>x.id===state.activeTicketId);
      if(!t){
        chatEl.innerHTML = "";
        return;
      }

      const html = (t.messages||[]).map(m=>{
        if(m.type==="sys"){
          return `<div class="sys"><div class="sys__bubble">${escapeHtml(m.text)}</div></div>`;
        }
        if(m.type==="me"){
          return `
            <div class="msgRow me">
              <div class="bubble me">
                ${escapeHtml(m.text)}
                <div class="meta">
                  <button class="delBtn" data-mid="${m.id}" title="Apagar">Apagar</button>
                  <span>${formatTime(m.ts)}</span>
                </div>
              </div>
            </div>
          `;
        }
        // client
        return `
          <div class="msgRow">
            <div class="bubble">
              ${escapeHtml(m.text)}
              <div class="meta"><span>${formatTime(m.ts)}</span></div>
            </div>
          </div>
        `;
      }).join("");

      chatEl.innerHTML = html;

      // delete message (only mine)
      chatEl.querySelectorAll(".delBtn").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          e.stopPropagation();
          const mid = btn.getAttribute("data-mid");
          t.messages = (t.messages||[]).filter(x=>x.id!==mid);
          saveState();
          renderChat(); // s√≥ o chat, sem mexer no resto
        });
      });

      // keep scroll at bottom on new render
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // ====== RENDER RIGHT (panel + tags) ======
    function renderPanel(){
      const t = state.tickets.find(x=>x.id===state.activeTicketId);
      if(!t){ panelBody.innerHTML = ""; return; }

      const tab = state.panelTab;

      if(tab==="info"){
        panelBody.innerHTML = `
          <div class="row"><div class="k">Pedido</div><div class="v">${escapeHtml(t.queue)}</div></div>
          <div class="row"><div class="k">Data</div><div class="v">${new Date(t.createdAt).toLocaleString()}</div></div>
          <div class="row"><div class="k">Categoria</div><div class="v" style="color:rgba(179,0,255,.95)">${escapeHtml(t.category)}</div></div>
          <div class="row"><div class="k">Valor total</div><div class="v" style="color:var(--good)">${escapeHtml(t.total)}</div></div>
          <div class="row"><div class="k">Nickname Roblox</div><div class="v">${escapeHtml(t.nick)}</div></div>
          <div class="row"><div class="k">Link da Gamepass</div><div class="v"><a class="v link" href="${t.gamepass}" target="_blank" rel="noreferrer">${escapeHtml(t.gamepass)}</a></div></div>
          <div class="row"><div class="k">Cliente registrado</div><div class="v">${escapeHtml(t.client)} <span class="muted">(${escapeHtml(t.clientEmail)})</span></div></div>
        `;
      }else if(tab==="items"){
        panelBody.innerHTML = `
          <div class="row"><div class="k">Item</div><div class="v">${escapeHtml(t.item)}</div></div>
          <div class="row"><div class="k">Status</div><div class="v">${escapeHtml(statusLabel(t.status))}</div></div>
          <div class="row"><div class="k">Fila</div><div class="v">${escapeHtml(queueLabel(t.queue))}</div></div>
        `;
      }else{
        panelBody.innerHTML = `
          <div class="row"><div class="k">A√ß√µes r√°pidas</div><div class="v"></div></div>
          <div class="muted" style="margin-top:6px; line-height:1.4">
            ‚Ä¢ ‚ÄúResolver‚Äù marca como ENTREGUE e agenda auto-remo√ß√£o (1h).<br/>
            ‚Ä¢ ‚ÄúLiberar‚Äù apenas marca como ‚Äúmeu ticket‚Äù (demo).<br/>
            ‚Ä¢ Notifica√ß√£o por email aqui √© demo (n√£o envia de verdade em site est√°tico).
          </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn small ghost" id="btnEmailDemo">Notificar por e-mail (demo)</button>
            <button class="btn small" id="btnMarkUnread">Marcar como n√£o lido</button>
          </div>
        `;

        const btnEmailDemo = document.getElementById("btnEmailDemo");
        const btnMarkUnread = document.getElementById("btnMarkUnread");

        btnEmailDemo?.addEventListener("click", ()=>{
          toast("Email (demo)", "Aqui seria enviado um e-mail pro cliente.");
        });
        btnMarkUnread?.addEventListener("click", ()=>{
          t.unread = true;
          saveState();
          renderAll();
        });
      }

      // stats
      document.getElementById("statSpent").textContent = String(t.spent ?? 13);
      document.getElementById("statOrders").textContent = String(t.orders ?? 1);
      document.getElementById("statItems").textContent = String(t.items ?? 1);
    }

    function renderTicketTags(){
      const t = state.tickets.find(x=>x.id===state.activeTicketId);
      if(!t){ ticketTagsEl.innerHTML = ""; return; }

      const tags = uniqueTags(t.tags || []);
      ticketTagsEl.innerHTML = tags.map(tag=>{
        return `<span class="tag removable" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</span>`;
      }).join("");

      // remove tag (sem reset / sem pular pro topo)
      ticketTagsEl.querySelectorAll(".tag.removable").forEach(el=>{
        el.addEventListener("click",(e)=>{
          e.preventDefault();
          e.stopPropagation();
          const tg = normalizeTag(el.getAttribute("data-tag"));
          t.tags = (t.tags||[]).map(normalizeTag).filter(x=>x!==tg);
          // se filtro tava nessa tag, limpa
          if(state.filters.tag && normalizeTag(state.filters.tag)===tg){
            state.filters.tag = null;
          }
          saveState();
          renderAll();
        });
      });
    }

    function renderAll(){
      renderQueueTabs();
      renderStatusPills();
      renderTagCloud();
      renderTicketList();
      renderChat();
      renderPanel();
      renderTicketTags();
      renderNotifications();
    }

    // ====== EVENTS ======

    // Tabs right panel
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        tab.classList.add("active");
        state.panelTab = tab.getAttribute("data-tab");
        saveState();
        renderPanel();
      });
    });

    // Filters open/close (pega clique em QUALQUER lugar do bot√£o, sem precisar "pontinha")
    btnFilters.addEventListener("click", (e)=>{
      e.preventDefault();
      filters.classList.add("open");
    });
    btnCloseFilters.addEventListener("click", ()=> filters.classList.remove("open"));
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){
        filters.classList.remove("open");
        notiPanel.classList.remove("open");
      }
    });

    // search + toggles
    searchInput.value = state.filters.search || "";
    searchInput.addEventListener("input", ()=>{
      state.filters.search = searchInput.value;
      saveState();
      renderAll();
    });

    onlyUnread.checked = !!state.filters.onlyUnread;
    onlyMine.checked = !!state.filters.onlyMine;
    soundOn.checked = !!state.filters.sound;
    demoSim.checked = !!state.filters.demo;
    sortBy.value = state.filters.sort || "recent";

    onlyUnread.addEventListener("change", ()=>{
      state.filters.onlyUnread = !!onlyUnread.checked;
      saveState();
      renderAll();
    });
    onlyMine.addEventListener("change", ()=>{
      state.filters.onlyMine = !!onlyMine.checked;
      saveState();
      renderAll();
    });
    soundOn.addEventListener("change", ()=>{
      state.filters.sound = !!soundOn.checked;
      saveState();
    });
    demoSim.addEventListener("change", ()=>{
      state.filters.demo = !!demoSim.checked;
      saveState();
    });
    sortBy.addEventListener("change", ()=>{
      state.filters.sort = sortBy.value;
      saveState();
      renderAll();
    });

    // send message
    function sendMessage(){
      const t = state.tickets.find(x=>x.id===state.activeTicketId);
      if(!t) return;
      const text = (msgInput.value||"").trim();
      if(!text) return;

      t.messages = t.messages || [];
      t.messages.push({ id: rid(), type:"me", text, ts: Date.now() });

      msgInput.value = "";
      saveState();
      renderChat();
      renderTicketList();
    }
    btnSend.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        sendMessage();
      }
    });

    // add tag
    function addTag(){
      const t = state.tickets.find(x=>x.id===state.activeTicketId);
      if(!t) return;
      const raw = (tagInput.value||"").trim();
      if(!raw) return;
      const tg = normalizeTag(raw);
      t.tags = uniqueTags([...(t.tags||[]), tg]);
      tagInput.value = "";
      saveState();
      renderAll();
    }
    btnAddTag.addEventListener("click", addTag);
    tagInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        addTag();
      }
    });

    // Liberar / Resolver
    btnLiberar.addEventListener("click", ()=>{
      const t = state.tickets.find(x=>x.id===state.activeTicketId);
      if(!t) return;
      t.mine = true;
      toast("Liberado", "Ticket marcado como seu (demo).");
      saveState();
      renderAll();
    });

    btnResolver.addEventListener("click", ()=>{
      const t = state.tickets.find(x=>x.id===state.activeTicketId);
      if(!t) return;

      t.status = "paid";
      t.tags = uniqueTags([...(t.tags||[]), "ENTREGUE"]);
      t.deliveredAt = Date.now();

      toast("Resolvido", "Marcado como ENTREGUE. Auto-remove em 1 hora.");
      saveState();
      renderAll();
    });

    // Notification bell panel
    btnBell.addEventListener("click", (e)=>{
      e.preventDefault();
      notiPanel.classList.toggle("open");
      filters.classList.remove("open");
    });
    btnMarkAllRead.addEventListener("click", ()=>{
      markAllNotificationsRead();
    });
    btnClearNoti.addEventListener("click", ()=>{
      clearNotifications();
    });

    // click outside closes panels
    document.addEventListener("click",(e)=>{
      const target = e.target;
      // close notifications if clicked outside
      if(notiPanel.classList.contains("open")){
        const insideNoti = notiPanel.contains(target) || btnBell.contains(target);
        if(!insideNoti) notiPanel.classList.remove("open");
      }
      // close filters if clicked outside
      if(filters.classList.contains("open")){
        const insideFilters = filters.contains(target) || btnFilters.contains(target);
        if(!insideFilters) filters.classList.remove("open");
      }
    });

    // ====== MOBILE NAV ======
    mNavList.addEventListener("click", ()=> setView("list"));
    mNavChat.addEventListener("click", ()=> setView("chat"));
    mNavDetails.addEventListener("click", ()=> setView("details"));
    btnMobileBack.addEventListener("click", ()=> setView("list"));

    // on resize: if desktop, ignore view; if mobile and no active view -> list
    window.addEventListener("resize", ()=>{
      if(isMobile()){
        if(!getView()) setView("list");
      }
    });

    // ====== DEMO POLLING (simula cliente respondendo) ======
    function randomPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function simulateClientReply(){
      if(!state.filters.demo) return;
      const visible = state.tickets.filter(t=> !t.deliveredAt);
      if(visible.length===0) return;
      if(Math.random() > SIMULATE_REPLY_PROB) return;

      const t = randomPick(visible);
      const txts = [
        "Oi, quando entrega meu item?",
        "Opa, onde envio o link da gamepass?",
        "N√£o achei onde mando o link üò≠",
        "Consegue me ajudar? t√° dando erro aqui",
        "Posso esperar, s√≥ me avisa aqui"
      ];

      t.messages = t.messages || [];
      const msg = { id: rid(), type:"client", text: randomPick(txts), ts: Date.now() };
      t.messages.push(msg);
      t.unread = true;

      // add notification (sem spam infinito: s√≥ cria 1 por mensagem)
      addNotification({
        ticketId: t.id,
        title: "Cliente respondeu",
        text: `${t.name}: ${msg.text}`
      });

      // toast s√≥ no desktop (no mobile j√° tem bell)
      if(!isMobile()){
        toast("Cliente respondeu", `${t.name}: ${msg.text}`);
      }

      saveState();
      // re-render list only (n√£o fica ‚Äún√£o para‚Äù porque n√£o fica empilhando toast sempre sem necessidade)
      renderTicketList();
      renderNotifications();
    }

    // ====== INIT ======
    document.getElementById("agentName").textContent = state.agent || AGENT;

    // start view: mobile list, desktop normal
    if(isMobile()){
      setView("list");
    }

    renderAll();
    setInterval(simulateClientReply, POLL_MS);
  </script>
</body>
</html>
